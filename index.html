<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Verificación de Placas</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        :root {
            --primary: #2c3e50;
            --primary-light: #34495e;
            --secondary: #3498db;
            --success: #27ae60;
            --warning: #f39c12;
            --danger: #e74c3c;
            --dark: #2c3e50;
            --light: #ecf0f1;
            --border-radius: 8px;
            --shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
            background: #f8f9fa;
            color: var(--dark);
            min-height: 100vh;
        }

        /* LOGIN SCREEN */
        .login-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, var(--primary), var(--primary-light));
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 10000;
            transition: opacity 0.5s ease;
        }

        .login-container {
            background: white;
            border-radius: var(--border-radius);
            padding: 40px;
            box-shadow: var(--shadow);
            width: 100%;
            max-width: 400px;
            text-align: center;
        }

        .login-container h2 {
            color: var(--primary);
            margin-bottom: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        .login-input-group {
            margin-bottom: 20px;
            text-align: left;
        }

        .login-input-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--dark);
        }

        .login-input-group input {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #ddd;
            border-radius: var(--border-radius);
            font-size: 16px;
            transition: all 0.3s ease;
        }

        .login-input-group input:focus {
            outline: none;
            border-color: var(--secondary);
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.2);
        }

        .login-btn {
            width: 100%;
            padding: 14px;
            background: linear-gradient(to right, var(--secondary), #2980b9);
            color: white;
            border: none;
            border-radius: var(--border-radius);
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        .login-btn:hover {
            background: linear-gradient(to right, #2980b9, var(--secondary));
            transform: translateY(-2px);
        }

        .login-error {
            color: var(--danger);
            font-size: 14px;
            margin-top: 10px;
            display: none;
        }

        .user-info {
            position: absolute;
            top: 20px;
            right: 20px;
            background: white;
            padding: 10px 15px;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            display: flex;
            align-items: center;
            gap: 10px;
            font-weight: 600;
            color: var(--primary);
            z-index: 100;
        }

        .user-info .user-type {
            background: var(--secondary);
            color: white;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 700;
        }

        .user-info .user-type.admin {
            background: var(--warning);
        }

        .user-info .user-type.creator {
            background: var(--danger);
        }

        .logout-btn {
            background: var(--danger);
            color: white;
            border: none;
            border-radius: 4px;
            padding: 4px 10px;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.3s ease;
        }

        .logout-btn:hover {
            background: #c0392b;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
            display: none;
        }

        /* Header */
        .header {
            background: linear-gradient(135deg, var(--primary), var(--primary-light));
            color: white;
            padding: 20px;
            border-radius: var(--border-radius);
            margin-bottom: 20px;
            box-shadow: var(--shadow);
            text-align: center;
        }

        .header h1 {
            font-size: 28px;
            font-weight: 700;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
        }

        /* Pestañas */
        .tabs {
            display: flex;
            background: white;
            border-radius: var(--border-radius) var(--border-radius) 0 0;
            overflow: hidden;
            box-shadow: var(--shadow);
        }

        .tab {
            flex: 1;
            padding: 18px;
            text-align: center;
            background: #f8f9fa;
            border: none;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            color: var(--dark);
            border-bottom: 3px solid transparent;
        }

        .tab:hover {
            background: #e9ecef;
        }

        .tab.active {
            background: white;
            color: var(--secondary);
            border-bottom: 3px solid var(--secondary);
        }

        .tab-content {
            display: none;
            background: white;
            border-radius: 0 0 var(--border-radius) var(--border-radius);
            box-shadow: var(--shadow);
            padding: 0;
            min-height: 600px;
        }

        .tab-content.active {
            display: block;
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* CONTENIDO PESTAÑA 1 - Verificación */
        .verification-container {
            display: flex;
            flex-direction: column;
            gap: 5px;
            padding: 20px;
        }

        /* Cuadros de visualización superior */
        .display-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 10px;
            margin-bottom: 15px;
        }

        .display-box {
            background: white;
            border-radius: var(--border-radius);
            padding: 15px;
            border: 2px solid #e0e0e0;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.08);
        }

        .display-label {
            font-size: 12px;
            font-weight: 600;
            color: #666;
            text-transform: uppercase;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .display-value {
            font-size: 18px;
            font-weight: 700;
            color: var(--primary);
            min-height: 30px;
            display: flex;
            align-items: center;
            word-break: break-word;
        }

        .display-value.empty {
            color: #999;
            font-style: italic;
        }

        /* Recuadro de texto largo */
        .input-container {
            margin: 10px 0;
            position: relative;
        }

        .input-label {
            font-size: 14px;
            font-weight: 600;
            color: var(--dark);
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .textarea-with-button {
            position: relative;
        }

        .clear-textarea-btn {
            background: var(--danger);
            color: white;
            border: none;
            border-radius: 4px;
            padding: 6px 12px;
            font-size: 12px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 5px;
            transition: all 0.3s ease;
            z-index: 10;
        }

        .clear-textarea-btn:hover {
            background: #c0392b;
            transform: translateY(-2px);
        }

        .large-textarea {
            width: 100%;
            padding: 20px;
            font-size: 16px;
            border: 2px solid #ddd;
            border-radius: var(--border-radius);
            resize: vertical;
            min-height: 120px;
            font-family: 'Consolas', 'Monaco', monospace;
            transition: all 0.3s ease;
            line-height: 1.5;
        }

        .large-textarea:focus {
            outline: none;
            border-color: var(--secondary);
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.2);
        }

        /* Botones centrales */
        .button-container {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin: 20px 0;
            flex-wrap: wrap;
        }

        .main-btn {
            padding: 12px 30px;
            font-size: 16px;
            font-weight: 600;
            border: none;
            border-radius: var(--border-radius);
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            min-width: 150px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }

        .main-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.15);
        }

        .main-btn:active {
            transform: translateY(-1px);
        }

        .main-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none !important;
        }

        .btn-check {
            background: linear-gradient(to right, var(--secondary), #2980b9);
            color: white;
        }

        .btn-registrar {
            background: linear-gradient(to right, var(--success), #229954);
            color: white;
        }

        .btn-observar {
            background: linear-gradient(to right, var(--warning), #e67e22);
            color: white;
        }

        .btn-check:hover { background: linear-gradient(to right, #2980b9, var(--secondary)); }
        .btn-registrar:hover { background: linear-gradient(to right, #229954, var(--success)); }
        .btn-observar:hover { background: linear-gradient(to right, #e67e22, var(--warning)); }

        /* Recuadros de estado y empresa */
        .status-container {
            display: grid;
            grid-template-columns: 1fr 2fr;
            gap: 15px;
            margin-top: 20px;
        }

        .status-box {
            background: white;
            border-radius: var(--border-radius);
            padding: 20px;
            border: 3px solid #e0e0e0;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.08);
            min-height: 120px;
            display: flex;
            flex-direction: column;
            transition: all 0.3s ease;
        }

        .status-box-title {
            font-size: 14px;
            font-weight: 600;
            color: #666;
            margin-bottom: 12px;
            text-transform: uppercase;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .status-box-content {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 22px;
            font-weight: 700;
            text-align: center;
            padding: 8px;
        }

        .placa-found {
            color: var(--success);
            border-color: var(--success);
            background: #f0fff4;
        }

        .placa-notfound {
            color: var(--danger);
            border-color: var(--danger);
            background: #fff0f0;
        }

        .placa-default {
            color: #999;
            border-color: #ddd;
            background: #f8f9fa;
        }

        .empresa-found {
            color: var(--primary);
            border-color: var(--primary);
            background: #f8f9fa;
        }

        .empresa-notfound {
            color: var(--warning);
            border-color: var(--warning);
            background: #fffaf0;
        }

        .empresa-default {
            color: #999;
            border-color: #ddd;
            background: #f8f9fa;
        }

        /* CONTENIDO PESTAÑA 2 - Base de Datos */
        .database-container {
            padding: 20px;
            min-height: 600px;
            overflow-y: auto;
        }

        /* CONTENIDO PESTAÑA 3 - Registros */
        .records-container {
            display: flex;
            flex-direction: column;
            gap: 20px;
            padding: 20px;
        }

        .records-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 20px;
        }

        @media (max-width: 1200px) {
            .records-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        @media (max-width: 768px) {
            .records-grid {
                grid-template-columns: 1fr;
            }
        }

        .records-box {
            background: white;
            border-radius: var(--border-radius);
            padding: 20px;
            border: 2px solid #e0e0e0;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.08);
            display: flex;
            flex-direction: column;
            height: 500px;
        }

        .records-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 12px;
            border-bottom: 2px solid #f0f0f0;
        }

        .records-title {
            font-size: 16px;
            font-weight: 700;
            color: var(--primary);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .records-count {
            font-size: 14px;
            font-weight: 600;
            background: var(--secondary);
            color: white;
            padding: 4px 12px;
            border-radius: 20px;
        }

        .records-list {
            flex: 1;
            overflow-y: auto;
            border: 1px solid #eee;
            border-radius: 6px;
            padding: 8px;
            background: #fafafa;
        }

        .record-item {
            padding: 12px;
            background: white;
            border-radius: 6px;
            margin-bottom: 8px;
            border-left: 4px solid var(--secondary);
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
            position: relative;
        }

        .record-item.accepted {
            border-left-color: var(--success);
        }

        .record-item.observed {
            border-left-color: var(--warning);
        }

        .record-placa {
            font-weight: 700;
            color: var(--primary);
            margin-bottom: 4px;
            font-size: 15px;
        }

        .record-details {
            font-size: 12px;
            color: #666;
            line-height: 1.4;
        }

        .no-records {
            text-align: center;
            padding: 30px 15px;
            color: #999;
        }

        .no-records i {
            font-size: 35px;
            margin-bottom: 10px;
            opacity: 0.5;
            display: block;
        }

        .export-btn {
            padding: 8px 20px;
            background: linear-gradient(to right, var(--success), #229954);
            color: white;
            border: none;
            border-radius: 6px;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 6px;
            transition: all 0.3s ease;
            margin: 0 auto;
        }

        .export-btn:hover {
            background: linear-gradient(to right, #229954, var(--success));
            transform: translateY(-2px);
        }

        .delete-record-btn {
            position: absolute;
            right: 10px;
            top: 10px;
            background: var(--danger);
            color: white;
            border: none;
            border-radius: 4px;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            opacity: 0.7;
            transition: all 0.3s ease;
            font-size: 12px;
        }

        .delete-record-btn:hover {
            opacity: 1;
            transform: scale(1.1);
            background: #c0392b;
        }

        /* Botones de limpieza en registros */
        .records-actions {
            display: flex;
            gap: 10px;
            margin-top: 15px;
            justify-content: center;
        }

        .delete-all-btn {
            padding: 8px 20px;
            background: linear-gradient(to right, var(--danger), #c0392b);
            color: white;
            border: none;
            border-radius: 6px;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 6px;
            transition: all 0.3s ease;
        }

        .delete-all-btn:hover {
            background: linear-gradient(to right, #c0392b, var(--danger));
            transform: translateY(-2px);
        }

        /* MODAL OBSERVACIONES */
        .observation-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            display: none;
        }

        .observation-modal-content {
            background: white;
            border-radius: var(--border-radius);
            padding: 30px;
            width: 90%;
            max-width: 500px;
            box-shadow: var(--shadow);
        }

        .observation-title {
            font-size: 20px;
            font-weight: 700;
            color: var(--primary);
            margin-bottom: 20px;
            text-align: center;
        }

        .observation-options {
            display: flex;
            flex-direction: column;
            gap: 12px;
            margin-bottom: 25px;
        }

        .observation-option {
            padding: 15px;
            border: 2px solid #ddd;
            border-radius: var(--border-radius);
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 10px;
            font-weight: 600;
        }

        .observation-option:hover {
            border-color: var(--warning);
            background: #fffaf0;
            transform: translateY(-2px);
        }

        .observation-option.selected {
            border-color: var(--warning);
            background: #fffaf0;
        }

        .observation-buttons {
            display: flex;
            gap: 15px;
            justify-content: center;
        }

        .observation-btn {
            padding: 12px 25px;
            border: none;
            border-radius: var(--border-radius);
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            min-width: 120px;
        }

        .observation-btn.confirm {
            background: linear-gradient(to right, var(--warning), #e67e22);
            color: white;
        }

        .observation-btn.cancel {
            background: #e0e0e0;
            color: var(--dark);
        }

        .observation-btn.confirm:hover {
            background: linear-gradient(to right, #e67e22, var(--warning));
            transform: translateY(-2px);
        }

        .observation-btn.cancel:hover {
            background: #d0d0d0;
            transform: translateY(-2px);
        }

        /* MODAL GESTIÓN DE USUARIOS */
        .user-management-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            display: none;
        }

        .user-management-modal-content {
            background: white;
            border-radius: var(--border-radius);
            padding: 30px;
            width: 90%;
            max-width: 800px;
            box-shadow: var(--shadow);
            max-height: 80vh;
            overflow-y: auto;
        }

        .user-management-title {
            font-size: 22px;
            font-weight: 700;
            color: var(--primary);
            margin-bottom: 25px;
            text-align: center;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        .user-form {
            background: #f8f9fa;
            border-radius: var(--border-radius);
            padding: 25px;
            margin-bottom: 25px;
        }

        .user-form h3 {
            margin-bottom: 20px;
            color: var(--primary);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 15px;
            margin-bottom: 20px;
        }

        @media (max-width: 768px) {
            .form-row {
                grid-template-columns: 1fr;
            }
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--dark);
        }

        .form-group input,
        .form-group select {
            width: 100%;
            padding: 10px 12px;
            border: 2px solid #ddd;
            border-radius: var(--border-radius);
            font-size: 14px;
            transition: all 0.3s ease;
        }

        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: var(--secondary);
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.2);
        }

        .form-buttons {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin-top: 20px;
        }

        .form-btn {
            padding: 12px 25px;
            border: none;
            border-radius: var(--border-radius);
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            min-width: 150px;
        }

        .form-btn.primary {
            background: linear-gradient(to right, var(--success), #229954);
            color: white;
        }

        .form-btn.secondary {
            background: linear-gradient(to right, var(--secondary), #2980b9);
            color: white;
        }

        .form-btn.danger {
            background: linear-gradient(to right, var(--danger), #c0392b);
            color: white;
        }

        .form-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }

        .users-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }

        .users-table th {
            background: var(--primary);
            color: white;
            padding: 12px;
            text-align: left;
            font-weight: 600;
        }

        .users-table td {
            padding: 12px;
            border-bottom: 1px solid #eee;
        }

        .users-table tr:hover {
            background: #f8f9fa;
        }

        .user-type-badge {
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 700;
            color: white;
        }

        .user-type-badge.usuario {
            background: var(--secondary);
        }

        .user-type-badge.administrador {
            background: var(--warning);
        }

        .user-type-badge.creador {
            background: var(--danger);
        }

        .action-buttons {
            display: flex;
            gap: 5px;
            align-items: center;
        }

        .action-btn {
            padding: 5px 10px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .action-btn.edit {
            background: var(--secondary);
            color: white;
        }

        .action-btn.delete {
            background: var(--danger);
            color: white;
        }

        .action-btn.reset {
            background: var(--warning);
            color: white;
        }

        .action-btn:hover {
            opacity: 0.9;
            transform: translateY(-1px);
        }

        /* Botón DELETE con icono */
        .delete-permanent-btn {
            background: linear-gradient(to right, #8b0000, #b22222);
            color: white;
            border: none;
            border-radius: 4px;
            padding: 6px 12px;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 5px;
            font-weight: 600;
        }

        .delete-permanent-btn:hover {
            background: linear-gradient(to right, #b22222, #8b0000);
            transform: translateY(-2px);
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
        }

        /* Selector de usuarios */
        .user-selector-container {
            background: #f8f9fa;
            border-radius: var(--border-radius);
            padding: 15px;
            margin-bottom: 20px;
            border: 2px solid #e0e0e0;
        }

        .user-selector-title {
            font-size: 14px;
            font-weight: 600;
            color: var(--primary);
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .user-selector-row {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .user-selector {
            padding: 8px 12px;
            border: 2px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
            flex: 1;
        }

        /* Alertas */
        .alert {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 20px;
            border-radius: 6px;
            color: white;
            font-weight: 600;
            z-index: 10000;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            max-width: 350px;
            animation: slideInAlert 0.3s ease-out;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .alert-success {
            background: var(--success);
            border-left: 4px solid #1e8449;
        }

        .alert-error {
            background: var(--danger);
            border-left: 4px solid #c0392b;
        }

        .alert-warning {
            background: var(--warning);
            border-left: 4px solid #d68910;
        }

        .alert-info {
            background: var(--secondary);
            border-left: 4px solid #2980b9;
        }

        @keyframes slideInAlert {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        @keyframes slideOutAlert {
            from { transform: translateX(0); opacity: 1; }
            to { transform: translateX(100%); opacity: 0; }
        }

        /* Estilos para la base de datos integrada */
        .database-header {
            background: linear-gradient(135deg, var(--primary), var(--primary-light));
            color: white;
            padding: 20px 30px;
            border-radius: var(--border-radius);
            margin-bottom: 20px;
            box-shadow: var(--shadow);
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 15px;
        }

        .database-header h2 {
            font-size: 24px;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .search-bar {
            background: white;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            padding: 15px 20px;
            margin-bottom: 20px;
        }

        .search-container {
            display: flex;
            gap: 10px;
        }

        .search-input {
            flex: 1;
            padding: 12px 14px;
            font-size: 14px;
            border: 2px solid #bdc3c7;
            border-radius: 6px;
            transition: all 0.3s ease;
        }

        .search-input:focus {
            outline: none;
            border-color: var(--secondary);
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.2);
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            min-width: 120px;
        }

        .btn-primary {
            background: linear-gradient(to right, var(--secondary), #2980b9);
            color: white;
        }

        .btn-primary:hover {
            background: linear-gradient(to right, #2980b9, var(--secondary));
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }

        .btn-success {
            background: linear-gradient(to right, var(--success), #229954);
            color: white;
        }

        .btn-success:hover {
            background: linear-gradient(to right, #229954, var(--success));
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }

        .btn-warning {
            background: linear-gradient(to right, var(--warning), #e67e22);
            color: white;
        }

        .btn-warning:hover {
            background: linear-gradient(to right, #e67e22, var(--warning));
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }

        .btn-danger {
            background: linear-gradient(to right, var(--danger), #c0392b);
            color: white;
        }

        .btn-danger:hover {
            background: linear-gradient(to right, #c0392b, var(--danger));
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }

        .btn-secondary {
            background: linear-gradient(to right, #95a5a6, #7f8c8d);
            color: white;
        }

        .btn-secondary:hover {
            background: linear-gradient(to right, #7f8c8d, #95a5a6);
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }

        .btn-info {
            background: linear-gradient(to right, #17a2b8, #138496);
            color: white;
        }

        .btn-info:hover {
            background: linear-gradient(to right, #138496, #17a2b8);
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }

        .btn-edit {
            background: linear-gradient(to right, #17a2b8, #138496);
            color: white;
        }

        .btn-edit:hover {
            background: linear-gradient(to right, #138496, #17a2b8);
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }

        .main-content-db {
            display: grid;
            grid-template-columns: 1fr 2fr;
            gap: 20px;
            margin-bottom: 20px;
        }

        @media (max-width: 1100px) {
            .main-content-db {
                grid-template-columns: 1fr;
            }
        }

        .left-column {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .registration-panel {
            background: white;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            overflow: hidden;
        }

        .registration-header {
            background: linear-gradient(to right, var(--primary), var(--primary-light));
            color: white;
            padding: 15px 20px;
            font-size: 16px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .registration-body {
            padding: 20px;
        }

        .form-group-db {
            margin-bottom: 15px;
        }

        .form-label-db {
            display: block;
            margin-bottom: 6px;
            font-weight: 600;
            color: var(--dark);
            font-size: 14px;
        }

        .form-control-db {
            width: 100%;
            padding: 12px 14px;
            border: 2px solid #bdc3c7;
            border-radius: 6px;
            font-size: 14px;
            transition: all 0.3s ease;
            background: white;
        }

        .form-control-db:focus {
            outline: none;
            border-color: var(--secondary);
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.2);
        }

        .controls-row {
            display: flex;
            justify-content: center;
            gap: 12px;
            margin: 20px 0;
            flex-wrap: wrap;
            padding: 0 20px;
        }

        .table-section {
            background: white;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            overflow: hidden;
        }

        .table-header-db {
            background: linear-gradient(to right, var(--primary), var(--primary-light));
            color: white;
            padding: 18px 25px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 15px;
        }

        .table-title-db {
            font-size: 18px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .table-wrapper {
            overflow-x: auto;
            max-height: 500px;
        }

        .db-table {
            width: 100%;
            border-collapse: collapse;
            min-width: 900px;
        }

        .db-table thead {
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .db-table th {
            background: #f8f9fa;
            color: var(--dark);
            font-weight: 700;
            padding: 16px 12px;
            text-align: left;
            border-bottom: 3px solid #dee2e6;
            font-size: 14px;
            position: relative;
        }

        .db-table th:not(:first-child)::after {
            content: '';
            position: absolute;
            right: 0;
            top: 20%;
            height: 60%;
            width: 1px;
            background: #dee2e6;
        }

        .db-table td {
            padding: 14px 12px;
            border-bottom: 1px solid #f0f0f0;
            vertical-align: middle;
            font-size: 14px;
        }

        .db-table tbody tr {
            transition: all 0.3s ease;
        }

        .db-table tbody tr:hover {
            background-color: #f8f9fa;
            transform: scale(1.002);
        }

        .db-table tbody tr.selected {
            background-color: #e7f3ff;
        }

        .stats-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 25px;
            background: #f8f9fa;
            border-top: 1px solid #dee2e6;
        }

        .stats-info {
            font-size: 14px;
            color: var(--dark);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .stats-numbers {
            display: flex;
            gap: 20px;
        }

        .stat-item {
            text-align: center;
        }

        .stat-value {
            font-size: 18px;
            font-weight: 700;
            color: var(--secondary);
            display: block;
        }

        .stat-label {
            font-size: 12px;
            color: #95a5a6;
        }

        .db-info {
            background: #f8f9fa;
            padding: 10px 15px;
            border-radius: 6px;
            margin-top: 10px;
            border-left: 4px solid var(--secondary);
            font-size: 12px;
            color: #6c757d;
        }

        .badge {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            margin-left: 8px;
        }

        .badge-success {
            background: #d4edda;
            color: #155724;
        }

        .badge-primary {
            background: #d1ecf1;
            color: #0c5460;
        }

        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            padding: 15px;
            backdrop-filter: blur(5px);
        }

        .modal-content {
            background: white;
            border-radius: var(--border-radius);
            width: 100%;
            max-width: 500px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            overflow: hidden;
            animation: modalSlideIn 0.3s ease;
        }

        @keyframes modalSlideIn {
            from { transform: translateY(-30px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        .modal-header {
            background: linear-gradient(to right, var(--secondary), #2980b9);
            color: white;
            padding: 20px;
            font-size: 18px;
            font-weight: 700;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .modal-close {
            background: none;
            border: none;
            color: white;
            font-size: 22px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .modal-close:hover {
            transform: rotate(90deg);
        }

        .modal-body {
            padding: 25px;
            max-height: 60vh;
            overflow-y: auto;
        }

        .modal-footer {
            padding: 18px 25px;
            background: #f8f9fa;
            display: flex;
            justify-content: flex-end;
            gap: 12px;
        }

        .spinner {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* File Upload */
        .file-upload {
            border: 2px dashed #dee2e6;
            border-radius: 8px;
            padding: 25px 15px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-bottom: 16px;
        }

        .file-upload:hover {
            border-color: var(--secondary);
            background: #f8f9fa;
        }

        .file-upload i {
            font-size: 40px;
            color: var(--secondary);
            margin-bottom: 12px;
        }

        .file-upload h3 {
            margin-bottom: 8px;
            color: var(--dark);
            font-size: 16px;
        }

        .file-upload p {
            color: #95a5a6;
            margin-bottom: 16px;
            font-size: 14px;
        }

        .file-input {
            display: none;
        }

        .import-instruction {
            background: #f0f8ff;
            padding: 12px 15px;
            border-radius: 6px;
            margin-bottom: 15px;
            border-left: 4px solid var(--secondary);
            font-size: 13px;
            color: var(--dark);
        }

        .import-instruction h4 {
            margin-bottom: 8px;
            color: var(--secondary);
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .import-instruction ul {
            margin-left: 20px;
            margin-bottom: 8px;
        }

        .import-instruction li {
            margin-bottom: 4px;
        }

        .sheet-info {
            background: #fff3e0;
            border: 1px solid #ffcc80;
            border-radius: 6px;
            padding: 10px 15px;
            margin-top: 10px;
            font-size: 12px;
            color: #e65100;
        }

        .excel-format {
            background: #e8f5e9;
            border: 1px solid #c8e6c9;
            border-radius: 6px;
            padding: 10px 15px;
            margin-top: 10px;
            font-size: 12px;
            color: #2e7d32;
        }

        /* Responsive */
        @media (max-width: 1200px) {
            .display-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        @media (max-width: 768px) {
            .display-grid {
                grid-template-columns: 1fr;
            }
            
            .status-container {
                grid-template-columns: 1fr;
            }
            
            .button-container {
                flex-direction: column;
                align-items: center;
            }
            
            .main-btn {
                width: 100%;
                max-width: 300px;
            }
            
            .tabs {
                flex-direction: column;
            }
            
            .records-actions {
                flex-direction: column;
            }

            .action-buttons {
                flex-direction: column;
                align-items: flex-start;
            }
            
            .user-selector-row {
                flex-direction: column;
            }

            .search-container {
                flex-direction: column;
            }

            .main-content-db {
                gap: 15px;
            }

            .controls-row {
                padding: 0 10px;
                gap: 8px;
            }

            .btn {
                min-width: 110px;
                padding: 8px 16px;
                font-size: 13px;
            }

            .table-header-db {
                flex-direction: column;
                align-items: flex-start;
                padding: 15px 20px;
            }

            .stats-row {
                flex-direction: column;
                gap: 15px;
                text-align: center;
            }

            .stats-numbers {
                width: 100%;
                justify-content: space-around;
            }
        }
    </style>
</head>
<body>
    <!-- PANTALLA DE LOGIN -->
    <div class="login-screen" id="loginScreen">
        <div class="login-container">
            <h2><i class="fas fa-car"></i> VERIFICACIÓN DE PLACAS</h2>
            <div class="login-input-group">
                <label for="username"><i class="fas fa-user"></i> USUARIO</label>
                <input type="text" id="username" placeholder="Ingrese su usuario">
            </div>
            <div class="login-input-group">
                <label for="password"><i class="fas fa-lock"></i> CONTRASEÑA</label>
                <input type="password" id="password" placeholder="Ingrese su contraseña">
            </div>
            <div class="login-error" id="loginError">
                Usuario o contraseña incorrectos
            </div>
            <button class="login-btn" id="loginBtn">
                <i class="fas fa-sign-in-alt"></i> INICIAR SESIÓN
            </button>
        </div>
    </div>

    <!-- INTERFAZ PRINCIPAL (oculta inicialmente) -->
    <div class="user-info" id="userInfo" style="display: none;">
        <i class="fas fa-user-circle"></i>
        <span id="currentUsername"></span>
        <span class="user-type" id="userType"></span>
        <div class="action-buttons" id="adminActions" style="display: none;">
            <button class="action-btn edit" id="manageUsersBtn" title="Gestión de usuarios">
                <i class="fas fa-users"></i>
            </button>
        </div>
        <button class="logout-btn" id="logoutBtn">
            <i class="fas fa-sign-out-alt"></i> SALIR
        </button>
    </div>

    <div class="container" id="mainContainer">
        <!-- Header -->
        <div class="header">
            <h1>
                <i class="fas fa-car"></i>
                SISTEMA DE VERIFICACIÓN Y REGISTRO DE PLACAS
            </h1>
        </div>

        <!-- Pestañas -->
        <div class="tabs">
            <button class="tab active" data-tab="verification">
                <i class="fas fa-search"></i> VERIFICACIÓN
            </button>
            <button class="tab" data-tab="database">
                <i class="fas fa-database"></i> BASE DE DATOS
            </button>
            <button class="tab" data-tab="records">
                <i class="fas fa-list-alt"></i> REGISTROS
            </button>
        </div>

        <!-- Contenido de Pestaña 1: Verificación -->
        <div class="tab-content active" id="verificationTab">
            <div class="verification-container">
                <!-- Cuadros de visualización superior -->
                <div class="display-grid">
                    <div class="display-box">
                        <div class="display-label">
                            <i class="fas fa-clipboard-check"></i> ESTADO DE TRÁMITE
                        </div>
                        <div id="estadoTramite" class="display-value empty">---</div>
                    </div>
                    
                    <div class="display-box">
                        <div class="display-label">
                            <i class="fas fa-hashtag"></i> N° DE TRÁMITE
                        </div>
                        <div id="numeroTramite" class="display-value empty">---</div>
                    </div>
                    
                    <div class="display-box">
                        <div class="display-label">
                            <i class="fas fa-tag"></i> TIPO HR
                        </div>
                        <div id="tipoHR" class="display-value empty">---</div>
                    </div>
                    
                    <div class="display-box">
                        <div class="display-label">
                            <i class="fas fa-plate-wheat"></i> NRO PLACA
                        </div>
                        <div id="nroPlaca" class="display-value empty">---</div>
                    </div>
                </div>

                <!-- Recuadro de texto largo -->
                <div class="input-container">
                    <div class="input-label">
                        <i class="fas fa-paste"></i> INGRESE LOS DATOS DEL TRÁMITE:
                        <button id="btnLimpiarDatos" class="clear-textarea-btn">
                            <i class="fas fa-times"></i> LIMPIAR
                        </button>
                    </div>
                    <div class="textarea-with-button">
                        <textarea id="inputDatos" class="large-textarea" placeholder="Pegue aquí los datos del trámite..."></textarea>
                    </div>
                </div>

                <!-- Botones centrales -->
                <div class="button-container">
                    <button id="btnCheck" class="main-btn btn-check">
                        <i class="fas fa-check-circle"></i> CHECK
                    </button>
                    <button id="btnRegistrar" class="main-btn btn-registrar" disabled>
                        <i class="fas fa-save"></i> REGISTRAR
                    </button>
                    <button id="btnObservar" class="main-btn btn-observar" disabled>
                        <i class="fas fa-eye"></i> OBSERVAR
                    </button>
                </div>

                <!-- Recuadros de estado y empresa -->
                <div class="status-container">
                    <div class="status-box placa-default" id="placaBox">
                        <div class="status-box-title">
                            <i class="fas fa-car"></i> ESTADO DE PLACA
                        </div>
                        <div class="status-box-content" id="placaStatus">---</div>
                    </div>
                    
                    <div class="status-box empresa-default" id="empresaBox">
                        <div class="status-box-title">
                            <i class="fas fa-building"></i> EMPRESA
                        </div>
                        <div class="status-box-content" id="empresaNombre">---</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Contenido de Pestaña 2: Base de Datos -->
        <div class="tab-content" id="databaseTab">
            <div class="database-container">
                <!-- Sistema de Base de Datos Multi-Usuario -->
                <div class="database-header">
                    <h2>
                        <i class="fas fa-database"></i>
                        SISTEMA DE GESTIÓN DE PLACAS (MULTI-USUARIO)
                    </h2>
                </div>

                <!-- Search Bar -->
                <div class="search-bar">
                    <div class="search-container">
                        <input type="text" id="buscarPlaca" class="search-input" placeholder="Buscar placa, empresa o asociación...">
                        <button id="btnBuscar" class="btn btn-primary">
                            <i class="fas fa-search"></i> BUSCAR
                        </button>
                        <button id="btnLimpiarBusqueda" class="btn btn-secondary">
                            <i class="fas fa-times"></i> LIMPIAR
                        </button>
                    </div>
                </div>

                <!-- Main Content -->
                <div class="main-content-db">
                    <!-- Left Column: Registration -->
                    <div class="left-column">
                        <div class="registration-panel">
                            <div class="registration-header">
                                <i class="fas fa-plus-circle"></i>
                                REGISTRO DE PLACAS
                            </div>
                            <div class="registration-body">
                                <div class="form-group-db">
                                    <label class="form-label-db">PLACA:</label>
                                    <input type="text" id="placa" class="form-control-db" placeholder="Ej: 5000-XKN, ABC-123" maxlength="20">
                                </div>
                                
                                <div class="form-group-db">
                                    <label class="form-label-db">EMPRESA:</label>
                                    <input type="text" id="empresa" class="form-control-db" placeholder="Ej: DGS OIL LTDA." maxlength="100">
                                </div>
                                
                                <div class="form-group-db">
                                    <label class="form-label-db">ASOCIACIÓN:</label>
                                    <input type="text" id="asociacion" class="form-control-db" placeholder="Ej: DGS OIL LTDA." maxlength="100">
                                </div>
                                
                                <div style="display: flex; gap: 12px; margin-top: 20px;">
                                    <button id="btnGuardar" class="btn btn-primary" style="flex: 1 1 0%;"><i class="fas fa-save"></i> GUARDAR</button>
                                    <button id="btnEditar" class="btn btn-info" style="flex: 1;"><i class="fas fa-edit"></i> EDITAR</button>
                                    <button id="btnLimpiarForm" class="btn btn-secondary" style="flex: 1;">
                                        <i class="fas fa-broom"></i> LIMPIAR
                                    </button>
                                </div>
                                
                                <div class="db-info">
                                    <i class="fas fa-database"></i> Base de datos: Multi-usuario - Datos compartidos entre todos los usuarios
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Right Column: Table -->
                    <div class="table-section">
                        <div class="table-header-db">
                            <div class="table-title-db">
                                <i class="fas fa-list"></i>
                                REGISTROS DE PLACAS
                                <span id="tableInfo" class="badge badge-primary">0 registros</span>
                            </div>
                        </div>
                        
                        <div class="table-wrapper">
                            <table id="placasTable" class="db-table">
                                <thead>
                                    <tr>
                                        <th>PLACA</th>
                                        <th>EMPRESA</th>
                                        <th>ASOCIACIÓN</th>
                                        <th>FECHA CREACIÓN</th>
                                        <th>ACCIONES</th>
                                    </tr>
                                </thead>
                                <tbody id="placasTableBody">
                                    <!-- Los registros se cargarán aquí -->
                                </tbody>
                            </table>
                        </div>
                        
                        <div class="stats-row">
                            <div class="stats-info">
                                <i class="fas fa-database"></i>
                                <span id="statsText">Total de registros en la base de datos</span>
                            </div>
                            <div class="stats-numbers">
                                <div class="stat-item">
                                    <span class="stat-value" id="totalRegistros">0</span>
                                    <span class="stat-label">TOTAL</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Controls Row -->
                <div class="controls-row">
                    <button id="btnExportarExcel" class="btn btn-success">
                        <i class="fas fa-file-excel"></i> EXPORTAR A EXCEL
                    </button>
                    <button id="btnImportarExcel" class="btn btn-primary">
                        <i class="fas fa-file-import"></i> IMPORTAR DE EXCEL
                    </button>
                    <button id="btnEliminarTodos" class="btn btn-danger">
                        <i class="fas fa-skull-crossbones"></i> ELIMINAR TODO
                    </button>
                </div>
            </div>
        </div>

        <!-- Contenido de Pestaña 3: Registros -->
        <div class="tab-content" id="recordsTab">
            <div class="records-container">
                <!-- Selector de usuario (solo para administradores/creador) -->
                <div class="user-selector-container" id="userSelectorContainer" style="display: none;">
                    <div class="user-selector-title">
                        <i class="fas fa-user-friends"></i> VER REGISTROS DE:
                    </div>
                    <div class="user-selector-row">
                        <select id="userSelector" class="user-selector">
                            <option value="current">Mis registros</option>
                        </select>
                        <button id="btnExportSelectedUser" class="export-btn" style="display: none;">
                            <i class="fas fa-file-excel"></i> EXPORTAR
                        </button>
                    </div>
                </div>

                <div class="records-grid">
                    <!-- Registros Aceptados -->
                    <div class="records-box">
                        <div class="records-header">
                            <div class="records-title">
                                <i class="fas fa-check-circle" style="color: var(--success);"></i>
                                REGISTROS ACEPTADOS
                            </div>
                            <div class="records-count" id="acceptedCount">0</div>
                        </div>
                        <div class="records-list" id="acceptedList">
                            <div class="no-records">
                                <i class="fas fa-check-circle"></i>
                                <h3>No hay registros aceptados</h3>
                                <p>Los registros aceptados aparecerán aquí</p>
                            </div>
                        </div>
                        <div class="records-actions">
                            <button id="btnExportAccepted" class="export-btn">
                                <i class="fas fa-file-excel"></i> EXPORTAR
                            </button>
                            <button id="btnDeleteAccepted" class="delete-all-btn" style="display: none;">
                                <i class="fas fa-trash"></i> ELIMINAR TODOS
                            </button>
                        </div>
                    </div>

                    <!-- Registros Observados (GLOBALES - COMPARTIDOS) -->
                    <div class="records-box">
                        <div class="records-header">
                            <div class="records-title">
                                <i class="fas fa-eye" style="color: var(--warning);"></i>
                                REGISTROS OBSERVADOS (COMPARTIDOS)
                            </div>
                            <div class="records-count" id="observedCount">0</div>
                        </div>
                        <div class="records-list" id="observedList">
                            <div class="no-records">
                                <i class="fas fa-eye"></i>
                                <h3>No hay registros observados</h3>
                                <p>Los registros observados compartidos aparecerán aquí</p>
                            </div>
                        </div>
                        <div class="records-actions">
                            <button id="btnExportObserved" class="export-btn">
                                <i class="fas fa-file-excel"></i> EXPORTAR
                            </button>
                            <button id="btnDeleteObserved" class="delete-all-btn" style="display: none;">
                                <i class="fas fa-trash"></i> ELIMINAR TODOS
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- MODAL PARA OBSERVACIONES -->
    <div class="observation-modal" id="observationModal">
        <div class="observation-modal-content">
            <div class="observation-title">
                <i class="fas fa-exclamation-triangle"></i> SELECCIONE TIPO DE OBSERVACIÓN
            </div>
            <div class="observation-options">
                <div class="observation-option" data-observation="Solicitado">
                    <i class="fas fa-hand-paper"></i>
                    SOLICITADO
                </div>
                <div class="observation-option" data-observation="Ruta Erronea">
                    <i class="fas fa-route"></i>
                    RUTA ERRÓNEA
                </div>
                <div class="observation-option" data-observation="Duplicada">
                    <i class="fas fa-copy"></i>
                    DUPLICADA
                </div>
                <div class="observation-option" data-observation="No identificada">
                    <i class="fas fa-question-circle"></i>
                    NO IDENTIFICADA
                </div>
                <div class="observation-option" data-observation="Error">
                    <i class="fas fa-times-circle"></i>
                    ERROR
                </div>
            </div>
            <div class="observation-buttons">
                <button class="observation-btn confirm" id="confirmObservation">
                    CONFIRMAR
                </button>
                <button class="observation-btn cancel" id="cancelObservation">
                    CANCELAR
                </button>
            </div>
        </div>
    </div>

    <!-- MODAL PARA GESTIÓN DE USUARIOS -->
    <div class="user-management-modal" id="userManagementModal">
        <div class="user-management-modal-content">
            <div class="user-management-title">
                <i class="fas fa-users-cog"></i> GESTIÓN DE USUARIOS
            </div>
            
            <div class="user-form">
                <h3><i class="fas fa-user-plus"></i> CREAR NUEVO USUARIO</h3>
                <div class="form-row">
                    <div class="form-group">
                        <label for="newUsername"><i class="fas fa-user"></i> USUARIO</label>
                        <input type="text" id="newUsername" placeholder="Nombre de usuario">
                    </div>
                    <div class="form-group">
                        <label for="newPassword"><i class="fas fa-lock"></i> CONTRASEÑA</label>
                        <input type="password" id="newPassword" placeholder="Contraseña">
                    </div>
                    <div class="form-group">
                        <label for="userTypeSelect"><i class="fas fa-user-tag"></i> TIPO DE USUARIO</label>
                        <select id="userTypeSelect">
                            <option value="usuario">Usuario</option>
                            <option value="administrador">Administrador</option>
                        </select>
                    </div>
                </div>
                <div class="form-buttons">
                    <button class="form-btn primary" id="createUserBtn">
                        <i class="fas fa-plus"></i> CREAR USUARIO
                    </button>
                    <button class="form-btn secondary" id="clearUserFormBtn">
                        <i class="fas fa-times"></i> LIMPIAR
                    </button>
                </div>
            </div>
            
            <h3><i class="fas fa-list"></i> USUARIOS REGISTRADOS</h3>
            <table class="users-table" id="usersTable">
                <thead>
                    <tr>
                        <th>Usuario</th>
                        <th>Tipo</th>
                        <th>Estado</th>
                        <th>Registros Aceptados</th>
                        <th>Acciones</th>
                    </tr>
                </thead>
                <tbody id="usersTableBody">
                    <!-- Los usuarios se cargarán aquí -->
                </tbody>
            </table>
            
            <div class="form-buttons" style="margin-top: 25px;">
                <button class="form-btn secondary" id="closeUserManagementBtn">
                    <i class="fas fa-times"></i> CERRAR
                </button>
            </div>
        </div>
    </div>

    <!-- MODALES PARA LA BASE DE DATOS -->
    <div id="importModal" class="modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <span><i class="fas fa-file-import"></i> IMPORTAR DESDE ARCHIVO EXCEL</span>
                <button class="modal-close" id="importModalClose">×</button>
            </div>
            <div class="modal-body">
                <div class="import-instruction">
                    <h4><i class="fas fa-info-circle"></i> FORMATO REQUERIDO PARA IMPORTAR</h4>
                    <ul>
                        <li><strong>Columna A:</strong> PLACA (Obligatorio)</li>
                        <li><strong>Columna B:</strong> EMPRESA (Opcional)</li>
                        <li><strong>Columna C:</strong> ASOCIACIÓN (Opcional)</li>
                    </ul>
                    <p style="margin: 0; font-size: 12px; color: #6c757d;">
                        El sistema leerá la primera hoja del archivo Excel.
                    </p>
                </div>
                
                <div class="file-upload" id="fileDropArea">
                    <i class="fas fa-cloud-upload-alt"></i>
                    <h3>Arrastra y suelta tu archivo Excel</h3>
                    <p>o haz clic para seleccionar</p>
                    <p style="font-size: 13px; color: #6c757d;">
                        Formatos soportados: .xlsx, .xls, .xlsm, .csv
                    </p>
                    <input type="file" id="fileInput" class="file-input" accept=".xlsx,.xls,.xlsm,.csv">
                    <button class="btn btn-primary" onclick="document.getElementById('fileInput').click()">
                        <i class="fas fa-folder-open"></i> SELECCIONAR ARCHIVO
                    </button>
                </div>
                
                <div id="fileInfo" style="display: none;">
                    <div style="background: #f8f9fa; padding: 12px; border-radius: 6px; margin-bottom: 15px; border: 1px solid #dee2e6;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                            <strong id="fileName" style="font-size: 14px;">archivo.xlsx</strong>
                            <button id="removeFile" class="btn btn-danger btn-sm">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                        <div id="fileDetails" style="font-size: 13px;"></div>
                        <div id="sheetInfo" class="sheet-info" style="display: block; margin-top: 8px;">
                            <i class="fas fa-table"></i> <span id="sheetName">Hoja: "Sheet1"</span>
                        </div>
                    </div>
                </div>

                <div style="margin-top: 15px;">
                    <label style="display: flex; align-items: center; gap: 8px; margin-bottom: 12px; font-size: 14px;">
                        <input type="checkbox" id="skipDuplicates" checked style="width: 16px; height: 16px;">
                        <span>Saltar placas duplicadas</span>
                    </label>
                </div>

                <div id="importPreview" style="margin-top: 15px; display: none;">
                    <h4 style="margin-bottom: 12px; color: var(--dark); font-size: 15px; display: flex; align-items: center; gap: 8px;">
                        <i class="fas fa-eye"></i> Vista Previa
                    </h4>
                    <div id="previewTable" style="max-height: 200px; overflow-y: auto; border: 1px solid #dee2e6; border-radius: 6px;">
                        <table style="width: 100%; border-collapse: collapse;">
                            <thead style="background: #f8f9fa; position: sticky; top: 0;">
                                <tr>
                                    <th style="padding: 8px; border-bottom: 2px solid #dee2e6; font-size: 13px; background: #e9ecef;">COLUMNA A: PLACA</th>
                                    <th style="padding: 8px; border-bottom: 2px solid #dee2e6; font-size: 13px; background: #e9ecef;">COLUMNA B: EMPRESA</th>
                                    <th style="padding: 8px; border-bottom: 2px solid #dee2e6; font-size: 13px; background: #e9ecef;">COLUMNA C: ASOCIACIÓN</th>
                                </tr>
                            </thead>
                            <tbody id="previewTableBody">
                                <!-- Vista previa se cargará aquí -->
                            </tbody>
                        </table>
                    </div>
                    <div id="previewStats" style="margin-top: 8px; font-size: 13px; color: #95a5a6;"></div>
                </div>
            </div>
            <div class="modal-footer">
                <button id="importCancel" class="btn btn-secondary">CANCELAR</button>
                <button id="importConfirm" class="btn btn-primary"><i class="fas fa-upload"></i> IMPORTAR</button>
            </div>
        </div>
    </div>

    <div id="confirmModal" class="modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <span id="confirmModalTitle"><i class="fas fa-exclamation-triangle"></i> ELIMINAR TODOS LOS REGISTROS</span>
                <button class="modal-close" id="confirmModalClose">×</button>
            </div>
            <div class="modal-body">
                <p id="confirmModalMessage" style="font-size: 15px; line-height: 1.5;"></p>
            </div>
            <div class="modal-footer">
                <button id="confirmModalCancel" class="btn btn-secondary">CANCELAR</button>
                <button id="confirmModalConfirm" class="btn btn-danger">CONFIRMAR</button>
            </div>
        </div>
    </div>

    <div id="resultModal" class="modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <span id="resultModalTitle"><i class="fas fa-check-circle"></i> RESUMEN DE IMPORTACIÓN</span>
                <button class="modal-close" id="resultModalClose">×</button>
            </div>
            <div class="modal-body">
                <div id="resultModalMessage" style="font-size: 15px; line-height: 1.5; white-space: pre-line;"></div>
            </div>
            <div class="modal-footer">
                <button id="resultModalCloseBtn" class="btn btn-primary">ACEPTAR</button>
            </div>
        </div>
    </div>

    <div id="sheetSelectModal" class="modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <span><i class="fas fa-table"></i> SELECCIONAR HOJA DE TRABAJO</span>
                <button class="modal-close" id="sheetSelectModalClose">×</button>
            </div>
            <div class="modal-body">
                <p style="margin-bottom: 15px; font-size: 14px;">
                    Se encontraron múltiples hojas en el archivo Excel. Seleccione la hoja que desea importar:
                </p>
                <div id="sheetList" style="max-height: 200px; overflow-y: auto;">
                    <!-- Lista de hojas se cargará aquí -->
                </div>
            </div>
            <div class="modal-footer">
                <button id="sheetSelectCancel" class="btn btn-secondary">CANCELAR</button>
            </div>
        </div>
    </div>

    <script>
        // ============================================
        // SISTEMA DE AUTENTICACIÓN Y GESTIÓN DE USUARIOS
        // ============================================
        class SistemaAutenticacion {
            constructor() {
                this.cargarUsuariosDesdeLocalStorage();
                this.usuarioActual = null;
                this.init();
            }
            
            cargarUsuariosDesdeLocalStorage() {
                try {
                    const usuariosGuardados = localStorage.getItem('sistema_usuarios_placas');
                    if (usuariosGuardados) {
                        this.usuarios = JSON.parse(usuariosGuardados);
                    } else {
                        this.usuarios = {
                            'admin': { 
                                password: 'admin123', 
                                tipo: 'creador',
                                fechaCreacion: new Date().toISOString(),
                                activo: true,
                                registrosAceptados: 0
                            },
                            'usuario1': { 
                                password: 'usuario123', 
                                tipo: 'usuario',
                                fechaCreacion: new Date().toISOString(),
                                activo: true,
                                registrosAceptados: 0
                            },
                            'usuario2': { 
                                password: 'usuario456', 
                                tipo: 'usuario',
                                fechaCreacion: new Date().toISOString(),
                                activo: true,
                                registrosAceptados: 0
                            }
                        };
                        this.guardarUsuariosEnLocalStorage();
                    }
                } catch (error) {
                    console.error('Error cargando usuarios:', error);
                    this.usuarios = {};
                }
            }
            
            guardarUsuariosEnLocalStorage() {
                try {
                    localStorage.setItem('sistema_usuarios_placas', JSON.stringify(this.usuarios));
                } catch (error) {
                    console.error('Error guardando usuarios:', error);
                }
            }
            
            init() {
                const sesion = localStorage.getItem('sesion_placa_sistema');
                if (sesion) {
                    const datosSesion = JSON.parse(sesion);
                    if (this.validarSesion(datosSesion)) {
                        this.usuarioActual = datosSesion;
                        this.iniciarInterfaz();
                    } else {
                        this.mostrarLogin();
                    }
                } else {
                    this.mostrarLogin();
                }
                
                this.bindEvents();
            }
            
            bindEvents() {
                document.getElementById('loginBtn').addEventListener('click', () => {
                    this.login();
                });
                
                document.getElementById('username').addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') this.login();
                });
                
                document.getElementById('password').addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') this.login();
                });
                
                document.getElementById('logoutBtn').addEventListener('click', () => {
                    this.logout();
                });
                
                document.getElementById('manageUsersBtn').addEventListener('click', () => {
                    this.mostrarGestionUsuarios();
                });
            }
            
            login() {
                const username = document.getElementById('username').value.trim();
                const password = document.getElementById('password').value;
                const errorElement = document.getElementById('loginError');
                
                if (username && password) {
                    if (this.usuarios[username] && 
                        this.usuarios[username].password === password && 
                        this.usuarios[username].activo !== false) {
                        
                        this.usuarioActual = {
                            username: username,
                            tipo: this.usuarios[username].tipo,
                            fechaCreacion: this.usuarios[username].fechaCreacion
                        };
                        
                        localStorage.setItem('sesion_placa_sistema', JSON.stringify(this.usuarioActual));
                        
                        this.iniciarInterfaz();
                        
                        errorElement.style.display = 'none';
                    } else {
                        errorElement.textContent = 'Usuario o contraseña incorrectos';
                        errorElement.style.display = 'block';
                        document.getElementById('password').value = '';
                    }
                } else {
                    errorElement.textContent = 'Complete todos los campos';
                    errorElement.style.display = 'block';
                }
            }
            
            logout() {
                this.usuarioActual = null;
                localStorage.removeItem('sesion_placa_sistema');
                this.mostrarLogin();
            }
            
            validarSesion(datosSesion) {
                return this.usuarios[datosSesion.username] && 
                       this.usuarios[datosSesion.username].tipo === datosSesion.tipo &&
                       this.usuarios[datosSesion.username].activo !== false;
            }
            
            mostrarLogin() {
                document.getElementById('loginScreen').style.display = 'flex';
                document.getElementById('mainContainer').style.display = 'none';
                document.getElementById('userInfo').style.display = 'none';
                
                document.getElementById('username').value = '';
                document.getElementById('password').value = '';
                document.getElementById('loginError').style.display = 'none';
            }
            
            iniciarInterfaz() {
                document.getElementById('loginScreen').style.display = 'none';
                
                document.getElementById('mainContainer').style.display = 'block';
                document.getElementById('userInfo').style.display = 'flex';
                
                document.getElementById('currentUsername').textContent = this.usuarioActual.username;
                document.getElementById('userType').textContent = this.usuarioActual.tipo.toUpperCase();
                
                const userTypeElement = document.getElementById('userType');
                userTypeElement.className = 'user-type';
                
                if (this.usuarioActual.tipo === 'administrador') {
                    userTypeElement.classList.add('admin');
                } else if (this.usuarioActual.tipo === 'creador') {
                    userTypeElement.classList.add('creator');
                }
                
                const adminActions = document.getElementById('adminActions');
                if (this.usuarioActual.tipo === 'creador') {
                    adminActions.style.display = 'flex';
                } else {
                    adminActions.style.display = 'none';
                }
                
                this.configurarPermisos();
                
                if (this.usuarioActual.tipo === 'administrador' || this.usuarioActual.tipo === 'creador') {
                    this.cargarSelectorUsuarios();
                }
                
                if (window.sistema) {
                    window.sistema.usuarioActual = this.usuarioActual;
                    window.sistema.cargarRegistrosDesdeLocalStorage();
                    window.sistema.actualizarContadores();
                    window.sistema.mostrarRegistrosAceptados();
                    window.sistema.mostrarRegistrosObservados();
                    window.sistema.configurarSelectorUsuarios();
                } else {
                    window.sistema = new SistemaVerificacionPlacas(this.usuarioActual);
                }
                
                if (this.usuarioActual.tipo !== 'usuario') {
                    this.inicializarBaseDeDatos();
                }
            }
            
            inicializarBaseDeDatos() {
                if (!window.placasDatabaseApp) {
                    window.placasDatabaseApp = new PlacasDatabaseApp();
                }
            }
            
            cargarSelectorUsuarios() {
                const userSelectorContainer = document.getElementById('userSelectorContainer');
                const userSelector = document.getElementById('userSelector');
                const deleteAcceptedBtn = document.getElementById('btnDeleteAccepted');
                const deleteObservedBtn = document.getElementById('btnDeleteObserved');
                
                if (this.usuarioActual.tipo === 'administrador' || this.usuarioActual.tipo === 'creador') {
                    userSelectorContainer.style.display = 'block';
                    
                    while (userSelector.options.length > 1) {
                        userSelector.remove(1);
                    }
                    
                    Object.entries(this.usuarios).forEach(([username, datos]) => {
                        if (datos.activo !== false && username !== this.usuarioActual.username) {
                            const option = document.createElement('option');
                            option.value = username;
                            option.textContent = `${username} (${datos.tipo})`;
                            userSelector.appendChild(option);
                        }
                    });
                    
                    deleteAcceptedBtn.style.display = 'flex';
                    deleteObservedBtn.style.display = 'flex';
                    
                    userSelector.addEventListener('change', (e) => {
                        const usuarioSeleccionado = e.target.value;
                        if (usuarioSeleccionado === 'current') {
                            if (window.sistema) {
                                window.sistema.mostrarRegistrosAceptados();
                                window.sistema.actualizarContadores();
                                document.getElementById('btnExportSelectedUser').style.display = 'none';
                            }
                        } else {
                            if (window.sistema) {
                                window.sistema.mostrarRegistrosOtroUsuario(usuarioSeleccionado);
                                document.getElementById('btnExportSelectedUser').style.display = 'flex';
                            }
                        }
                    });
                    
                    document.getElementById('btnExportSelectedUser').addEventListener('click', () => {
                        const usuarioSeleccionado = userSelector.value;
                        if (usuarioSeleccionado && usuarioSeleccionado !== 'current') {
                            window.sistema.exportarRegistrosUsuario(usuarioSeleccionado);
                        }
                    });
                    
                } else {
                    userSelectorContainer.style.display = 'none';
                    deleteAcceptedBtn.style.display = 'none';
                    deleteObservedBtn.style.display = 'none';
                }
            }
            
            configurarPermisos() {
                const tabs = document.querySelectorAll('.tab');
                
                tabs.forEach(tab => {
                    const tabId = tab.dataset.tab;
                    
                    if (this.usuarioActual.tipo === 'usuario') {
                        if (tabId === 'database') {
                            tab.style.display = 'none';
                        } else {
                            tab.style.display = 'flex';
                        }
                    } else {
                        tab.style.display = 'flex';
                    }
                });
            }
            
            mostrarGestionUsuarios() {
                if (this.usuarioActual.tipo !== 'creador') {
                    this.mostrarAlerta('Acceso denegado', 'Solo el creador puede gestionar usuarios', 'error');
                    return;
                }
                
                const modal = document.getElementById('userManagementModal');
                modal.style.display = 'flex';
                
                this.cargarListaUsuarios();
                
                this.configurarEventosGestionUsuarios();
            }
            
            configurarEventosGestionUsuarios() {
                document.getElementById('createUserBtn').addEventListener('click', () => {
                    this.crearUsuario();
                });
                
                document.getElementById('clearUserFormBtn').addEventListener('click', () => {
                    this.limpiarFormularioUsuario();
                });
                
                document.getElementById('closeUserManagementBtn').addEventListener('click', () => {
                    document.getElementById('userManagementModal').style.display = 'none';
                });
            }
            
            cargarListaUsuarios() {
                const tbody = document.getElementById('usersTableBody');
                tbody.innerHTML = '';
                
                Object.entries(this.usuarios).forEach(([username, datos]) => {
                    const keyAceptados = `registrosAceptados_${username}`;
                    const registrosAceptadosStr = localStorage.getItem(keyAceptados);
                    const registrosAceptados = registrosAceptadosStr ? JSON.parse(registrosAceptadosStr) : [];
                    
                    const row = document.createElement('tr');
                    
                    const fechaCreacion = new Date(datos.fechaCreacion);
                    const hoy = new Date();
                    const dias = Math.floor((hoy - fechaCreacion) / (1000 * 60 * 60 * 24));
                    
                    row.innerHTML = `
                        <td>${username}</td>
                        <td>
                            <span class="user-type-badge ${datos.tipo}">
                                ${datos.tipo.toUpperCase()}
                            </span>
                        </td>
                        <td>
                            <span style="color: ${datos.activo !== false ? 'var(--success)' : 'var(--danger)'}; font-weight: 600;">
                                ${datos.activo !== false ? 'ACTIVO' : 'INACTIVO'}
                            </span>
                            <br>
                            <small>Hace ${dias} días</small>
                        </td>
                        <td>
                            <span style="font-weight: 700; color: var(--primary);">${registrosAceptados.length}</span>
                        </td>
                        <td>
                            <div class="action-buttons">
                                ${username !== 'admin' ? `
                                    <button class="action-btn edit" onclick="sistemaAuth.editarUsuario('${username}')">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                    <button class="action-btn reset" onclick="sistemaAuth.resetearPassword('${username}')">
                                        <i class="fas fa-key"></i>
                                    </button>
                                    <button class="delete-permanent-btn" onclick="sistemaAuth.eliminarDefinitivamenteUsuario('${username}')" title="Eliminar definitivamente">
                                        <i class="fas fa-trash"></i> DELETE
                                    </button>
                                ` : `
                                    <span style="color: #666; font-size: 12px;">Usuario del sistema</span>
                                `}
                            </div>
                        </td>
                    `;
                    
                    tbody.appendChild(row);
                });
            }
            
            crearUsuario() {
                const username = document.getElementById('newUsername').value.trim();
                const password = document.getElementById('newPassword').value;
                const tipo = document.getElementById('userTypeSelect').value;
                
                if (!username || !password) {
                    this.mostrarAlerta('Error', 'Complete todos los campos', 'error');
                    return;
                }
                
                if (username.length < 3) {
                    this.mostrarAlerta('Error', 'El usuario debe tener al menos 3 caracteres', 'error');
                    return;
                }
                
                if (password.length < 4) {
                    this.mostrarAlerta('Error', 'La contraseña debe tener al menos 4 caracteres', 'error');
                    return;
                }
                
                if (this.usuarios[username]) {
                    this.mostrarAlerta('Error', 'El usuario ya existe', 'error');
                    return;
                }
                
                this.usuarios[username] = {
                    password: password,
                    tipo: tipo,
                    fechaCreacion: new Date().toISOString(),
                    activo: true
                };
                
                this.guardarUsuariosEnLocalStorage();
                
                this.cargarListaUsuarios();
                
                this.cargarSelectorUsuarios();
                
                this.limpiarFormularioUsuario();
                
                this.mostrarAlerta('Éxito', `Usuario ${username} creado como ${tipo}`, 'success');
            }
            
            editarUsuario(username) {
                const nuevoTipo = prompt(`Editar tipo de usuario para ${username}:\n\n1. usuario\n2. administrador\n\nIngrese el nuevo tipo:`, this.usuarios[username].tipo);
                
                if (nuevoTipo && (nuevoTipo === 'usuario' || nuevoTipo === 'administrador')) {
                    this.usuarios[username].tipo = nuevoTipo;
                    this.guardarUsuariosEnLocalStorage();
                    this.cargarListaUsuarios();
                    this.cargarSelectorUsuarios();
                    this.mostrarAlerta('Éxito', `Usuario ${username} actualizado a ${nuevoTipo}`, 'success');
                }
            }
            
            resetearPassword(username) {
                const nuevaPassword = prompt(`Resetear contraseña para ${username}:\n\nIngrese la nueva contraseña:`, '');
                
                if (nuevaPassword && nuevaPassword.length >= 4) {
                    this.usuarios[username].password = nuevaPassword;
                    this.guardarUsuariosEnLocalStorage();
                    this.mostrarAlerta('Éxito', `Contraseña resetada para ${username}`, 'success');
                } else if (nuevaPassword) {
                    this.mostrarAlerta('Error', 'La contraseña debe tener al menos 4 caracteres', 'error');
                }
            }
            
            eliminarDefinitivamenteUsuario(username) {
                if (username === 'admin') {
                    this.mostrarAlerta('Error', 'No se puede eliminar al usuario administrador principal', 'error');
                    return;
                }
                
                if (confirm(`¿ESTÁ SEGURO DE ELIMINAR DEFINITIVAMENTE al usuario ${username}?\n\n⚠️ ESTA ACCIÓN NO SE PUEDE DESHACER ⚠️\n\nSe eliminarán también todos sus registros.`)) {
                    delete this.usuarios[username];
                    
                    this.eliminarRegistrosUsuario(username);
                    
                    this.guardarUsuariosEnLocalStorage();
                    this.cargarListaUsuarios();
                    
                    this.cargarSelectorUsuarios();
                    
                    if (window.sistema) {
                        const userSelector = document.getElementById('userSelector');
                        if (userSelector && userSelector.value === username) {
                            userSelector.value = 'current';
                            window.sistema.mostrarRegistrosAceptados();
                            document.getElementById('btnExportSelectedUser').style.display = 'none';
                        }
                    }
                    
                    this.mostrarAlerta('Éxito', `Usuario ${username} eliminado definitivamente`, 'success');
                }
            }
            
            eliminarRegistrosUsuario(username) {
                const keyAceptados = `registrosAceptados_${username}`;
                localStorage.removeItem(keyAceptados);
                
                const keyObservados = `registrosObservados_${username}`;
                localStorage.removeItem(keyObservados);
            }
            
            limpiarFormularioUsuario() {
                document.getElementById('newUsername').value = '';
                document.getElementById('newPassword').value = '';
                document.getElementById('userTypeSelect').value = 'usuario';
            }
            
            mostrarAlerta(titulo, mensaje, tipo = 'info') {
                const alerta = document.createElement('div');
                
                let clase = 'alert-info';
                switch(tipo) {
                    case 'success': clase = 'alert-success'; break;
                    case 'error': clase = 'alert-error'; break;
                    case 'warning': clase = 'alert-warning'; break;
                }
                
                alerta.className = `alert ${clase}`;
                
                let icono = 'fas fa-info-circle';
                if (tipo === 'success') icono = 'fas fa-check-circle';
                if (tipo === 'error') icono = 'fas fa-times-circle';
                if (tipo === 'warning') icono = 'fas fa-exclamation-triangle';
                
                alerta.innerHTML = `
                    <i class="${icono}" style="font-size: 18px; margin-top: 2px;"></i>
                    <div>
                        <div style="font-size: 14px; margin-bottom: 4px; font-weight: 700;">${titulo}</div>
                        <div style="font-size: 13px; opacity: 0.9;">${mensaje}</div>
                    </div>
                `;
                
                document.body.appendChild(alerta);
                
                setTimeout(() => {
                    alerta.style.animation = 'slideOutAlert 0.3s ease-out';
                    setTimeout(() => {
                        if (alerta.parentNode) {
                            alerta.parentNode.removeChild(alerta);
                        }
                    }, 300);
                }, 4000);
            }
        }

        // ============================================
        // SISTEMA DE GESTIÓN DE BASE DE DATOS (ADAPTADO)
        // ============================================
        class PlacaValidator {
            static normalizarPlaca(placa) {
                if (!placa) return "";
                return placa.toString().toUpperCase().replace(/[-\s]/g, '');
            }
            
            static validarFormatoPlaca(placa) {
                if (!placa || placa.trim().length < 3) return false;
                return true;
            }
            
            static compararPlacas(placa1, placa2) {
                return this.normalizarPlaca(placa1) === this.normalizarPlaca(placa2);
            }
        }

        class Placa {
            constructor(id, placa, empresa, asociacion, fechaCreacion) {
                this.id = id || Date.now();
                this.placa = placa;
                this.empresa = empresa || "";
                this.asociacion = asociacion || "";
                this.fechaCreacion = fechaCreacion || new Date().toISOString();
            }
            
            toTableRow() {
                const fecha = new Date(this.fechaCreacion);
                const fechaFormateada = fecha.toLocaleDateString('es-ES', {
                    year: 'numeric',
                    month: '2-digit',
                    day: '2-digit',
                    hour: '2-digit',
                    minute: '2-digit'
                });
                
                return {
                    id: this.id,
                    placa: this.placa,
                    empresa: this.empresa,
                    asociacion: this.asociacion,
                    fechaCreacion: fechaFormateada
                };
            }
        }

        class ExcelManager {
            constructor() {
                if (typeof XLSX === 'undefined') {
                    throw new Error('SheetJS (XLSX) no está cargado.');
                }
            }
            
            async leerArchivoExcel(archivo) {
                return new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    
                    reader.onload = (e) => {
                        try {
                            const data = e.target.result;
                            const workbook = XLSX.read(data, {
                                type: 'binary',
                                cellDates: true,
                                cellText: false
                            });
                            
                            resolve(workbook);
                        } catch (error) {
                            reject(new Error(`Error al leer el archivo Excel: ${error.message}`));
                        }
                    };
                    
                    reader.onerror = () => {
                        reject(new Error('Error al leer el archivo'));
                    };
                    
                    reader.readAsBinaryString(archivo);
                });
            }
            
            obtenerHojasDisponibles(workbook) {
                return workbook.SheetNames.map(name => ({
                    name: name,
                    sheet: workbook.Sheets[name]
                }));
            }
            
            leerDatosDeHoja(sheet, options = {}) {
                const defaultOptions = {
                    range: null,
                    header: 1,
                    blankrows: false,
                    defval: ''
                };
                
                const config = { ...defaultOptions, ...options };
                let jsonData = XLSX.utils.sheet_to_json(sheet, config);
                
                const datos = [];
                
                jsonData.forEach((fila, index) => {
                    const placa = fila[0] || "";
                    const empresa = fila[1] || "";
                    const asociacion = fila[2] || "";
                    
                    if (placa && placa.toString().trim()) {
                        datos.push({
                            placa: placa.toString().trim(),
                            empresa: empresa.toString().trim(),
                            asociacion: asociacion.toString().trim(),
                            rowNumber: index + 1
                        });
                    }
                });
                
                return datos;
            }
            
            crearWorkbookDesdeDatos(datos) {
                const rows = [];
                
                rows.push(['PLACA', 'EMPRESA', 'ASOCIACIÓN', 'FECHA CREACIÓN']);
                
                datos.forEach(placa => {
                    const fecha = new Date(placa.fechaCreacion);
                    const fechaFormateada = fecha.toLocaleDateString('es-ES', {
                        year: 'numeric',
                        month: '2-digit',
                        day: '2-digit',
                        hour: '2-digit',
                        minute: '2-digit'
                    });
                    
                    rows.push([
                        placa.placa,
                        placa.empresa,
                        placa.asociacion,
                        fechaFormateada
                    ]);
                });
                
                const worksheet = XLSX.utils.aoa_to_sheet(rows);
                
                const columnWidths = [
                    { wch: 15 },
                    { wch: 30 },
                    { wch: 30 },
                    { wch: 20 }
                ];
                worksheet['!cols'] = columnWidths;
                
                const workbook = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(workbook, worksheet, 'Placas');
                
                return workbook;
            }
            
            descargarWorkbook(workbook, nombreArchivo) {
                const excelBuffer = XLSX.write(workbook, {
                    bookType: 'xlsx',
                    type: 'binary'
                });
                
                const blob = new Blob([this.s2ab(excelBuffer)], {
                    type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet'
                });
                
                const url = URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.href = url;
                link.download = nombreArchivo || `placas_${new Date().toISOString().slice(0, 10)}.xlsx`;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                setTimeout(() => URL.revokeObjectURL(url), 100);
            }
            
            s2ab(s) {
                const buf = new ArrayBuffer(s.length);
                const view = new Uint8Array(buf);
                for (let i = 0; i < s.length; i++) {
                    view[i] = s.charCodeAt(i) & 0xFF;
                }
                return buf;
            }
        }

        class MultiUserDatabase {
            constructor() {
                this.dbName = 'placas_multi_usuario';
                this.storeName = 'placas';
                this.excelManager = new ExcelManager();
                this.placaEditando = null;
                this.init();
            }
            
            async init() {
                if (!window.indexedDB) {
                    console.warn('IndexedDB no soportado, usando localStorage como fallback');
                    this.useLocalStorage = true;
                    this.ensureLocalStorage();
                } else {
                    await this.initIndexedDB();
                }
            }
            
            async initIndexedDB() {
                return new Promise((resolve, reject) => {
                    const request = indexedDB.open(this.dbName, 1);
                    
                    request.onerror = (event) => {
                        console.error('Error abriendo IndexedDB:', event.target.error);
                        this.useLocalStorage = true;
                        this.ensureLocalStorage();
                        resolve();
                    };
                    
                    request.onsuccess = (event) => {
                        this.db = event.target.result;
                        console.log('IndexedDB conectado');
                        resolve();
                    };
                    
                    request.onupgradeneeded = (event) => {
                        const db = event.target.result;
                        if (!db.objectStoreNames.contains(this.storeName)) {
                            const store = db.createObjectStore(this.storeName, { keyPath: 'id', autoIncrement: true });
                            store.createIndex('placa', 'placa', { unique: true });
                            store.createIndex('empresa', 'empresa', { unique: false });
                            store.createIndex('fechaCreacion', 'fechaCreacion', { unique: false });
                        }
                    };
                });
            }
            
            ensureLocalStorage() {
                if (!localStorage.getItem(this.dbName)) {
                    localStorage.setItem(this.dbName, JSON.stringify([]));
                }
            }
            
            async insertarPlaca(placa, empresa, asociacion) {
                const nuevaPlaca = new Placa(null, placa, empresa, asociacion);
                
                if (this.useLocalStorage) {
                    const datos = JSON.parse(localStorage.getItem(this.dbName) || '[]');
                    
                    const existe = datos.some(p => 
                        PlacaValidator.compararPlacas(p.placa, placa)
                    );
                    
                    if (existe) {
                        throw new Error(`La placa ${placa} ya existe en la base de datos`);
                    }
                    
                    datos.push(nuevaPlaca);
                    localStorage.setItem(this.dbName, JSON.stringify(datos));
                } else {
                    return new Promise((resolve, reject) => {
                        const transaction = this.db.transaction([this.storeName], 'readwrite');
                        const store = transaction.objectStore(this.storeName);
                        
                        const request = store.add(nuevaPlaca);
                        
                        request.onsuccess = () => {
                            nuevaPlaca.id = request.result;
                            resolve(nuevaPlaca);
                        };
                        
                        request.onerror = (event) => {
                            if (event.target.error.name === 'ConstraintError') {
                                reject(new Error(`La placa ${placa} ya existe en la base de datos`));
                            } else {
                                reject(new Error('Error al insertar placa: ' + event.target.error));
                            }
                        };
                    });
                }
                
                return nuevaPlaca;
            }
            
            async buscarPlacas(termino = null) {
                if (this.useLocalStorage) {
                    let datos = JSON.parse(localStorage.getItem(this.dbName) || '[]');
                    
                    if (termino && termino.trim() !== '') {
                        const terminoNormalizado = PlacaValidator.normalizarPlaca(termino);
                        const terminoMinusculas = termino.toLowerCase();
                        
                        datos = datos.filter(p => {
                            const placaNormalizada = PlacaValidator.normalizarPlaca(p.placa);
                            return (
                                placaNormalizada.includes(terminoNormalizado) ||
                                p.empresa.toLowerCase().includes(terminoMinusculas) ||
                                p.asociacion.toLowerCase().includes(terminoMinusculas)
                            );
                        });
                    }
                    
                    datos.sort((a, b) => new Date(b.fechaCreacion) - new Date(a.fechaCreacion));
                    
                    return datos.map(p => new Placa(p.id, p.placa, p.empresa, p.asociacion, p.fechaCreacion));
                } else {
                    return new Promise((resolve, reject) => {
                        const transaction = this.db.transaction([this.storeName], 'readonly');
                        const store = transaction.objectStore(this.storeName);
                        const request = store.getAll();
                        
                        request.onsuccess = () => {
                            let datos = request.result;
                            
                            if (termino && termino.trim() !== '') {
                                const terminoNormalizado = PlacaValidator.normalizarPlaca(termino);
                                const terminoMinusculas = termino.toLowerCase();
                                
                                datos = datos.filter(p => {
                                    const placaNormalizada = PlacaValidator.normalizarPlaca(p.placa);
                                    return (
                                        placaNormalizada.includes(terminoNormalizado) ||
                                        p.empresa.toLowerCase().includes(terminoMinusculas) ||
                                        p.asociacion.toLowerCase().includes(terminoMinusculas)
                                    );
                                });
                            }
                            
                            datos.sort((a, b) => new Date(b.fechaCreacion) - new Date(a.fechaCreacion));
                            
                            const placas = datos.map(p => new Placa(p.id, p.placa, p.empresa, p.asociacion, p.fechaCreacion));
                            resolve(placas);
                        };
                        
                        request.onerror = () => {
                            reject(new Error('Error al buscar placas'));
                        };
                    });
                }
            }
            
            async verificarPlacaExiste(placa) {
                const placas = await this.buscarPlacas(placa);
                return placas.find(p => PlacaValidator.compararPlacas(p.placa, placa)) || null;
            }
            
            async actualizarPlaca(id, placa, empresa, asociacion) {
                const placaActualizada = new Placa(id, placa, empresa, asociacion, new Date().toISOString());
                
                if (this.useLocalStorage) {
                    const datos = JSON.parse(localStorage.getItem(this.dbName) || '[]');
                    const index = datos.findIndex(p => p.id === id);
                    
                    if (index === -1) {
                        throw new Error('Placa no encontrada');
                    }
                    
                    const existeOtra = datos.some((p, i) => 
                        i !== index && PlacaValidator.compararPlacas(p.placa, placa)
                    );
                    
                    if (existeOtra) {
                        throw new Error(`La placa ${placa} ya existe en la base de datos`);
                    }
                    
                    datos[index] = placaActualizada;
                    localStorage.setItem(this.dbName, JSON.stringify(datos));
                } else {
                    return new Promise((resolve, reject) => {
                        const transaction = this.db.transaction([this.storeName], 'readwrite');
                        const store = transaction.objectStore(this.storeName);
                        
                        const request = store.put(placaActualizada);
                        
                        request.onsuccess = () => {
                            resolve(placaActualizada);
                        };
                        
                        request.onerror = (event) => {
                            if (event.target.error.name === 'ConstraintError') {
                                reject(new Error(`La placa ${placa} ya existe en la base de datos`));
                            } else {
                                reject(new Error('Error al actualizar placa: ' + event.target.error));
                            }
                        };
                    });
                }
                
                return placaActualizada;
            }
            
            async eliminarPlaca(id) {
                if (this.useLocalStorage) {
                    const datos = JSON.parse(localStorage.getItem(this.dbName) || '[]');
                    const nuevaData = datos.filter(p => p.id !== id);
                    
                    if (nuevaData.length === datos.length) {
                        throw new Error('Placa no encontrada');
                    }
                    
                    localStorage.setItem(this.dbName, JSON.stringify(nuevaData));
                } else {
                    return new Promise((resolve, reject) => {
                        const transaction = this.db.transaction([this.storeName], 'readwrite');
                        const store = transaction.objectStore(this.storeName);
                        
                        const request = store.delete(id);
                        
                        request.onsuccess = () => {
                            resolve(true);
                        };
                        
                        request.onerror = () => {
                            reject(new Error('Error al eliminar placa'));
                        };
                    });
                }
                
                return true;
            }
            
            async eliminarTodasPlacas() {
                if (this.useLocalStorage) {
                    localStorage.setItem(this.dbName, JSON.stringify([]));
                } else {
                    return new Promise((resolve, reject) => {
                        const transaction = this.db.transaction([this.storeName], 'readwrite');
                        const store = transaction.objectStore(this.storeName);
                        
                        const request = store.clear();
                        
                        request.onsuccess = () => {
                            resolve(true);
                        };
                        
                        request.onerror = () => {
                            reject(new Error('Error al eliminar todas las placas'));
                        };
                    });
                }
                
                return true;
            }
            
            async contarRegistros() {
                if (this.useLocalStorage) {
                    const datos = JSON.parse(localStorage.getItem(this.dbName) || '[]');
                    return datos.length;
                } else {
                    return new Promise((resolve, reject) => {
                        const transaction = this.db.transaction([this.storeName], 'readonly');
                        const store = transaction.objectStore(this.storeName);
                        const request = store.count();
                        
                        request.onsuccess = () => {
                            resolve(request.result);
                        };
                        
                        request.onerror = () => {
                            reject(new Error('Error al contar registros'));
                        };
                    });
                }
            }
            
            async importarDesdeExcel(archivo, saltarDuplicados = true, hojaSeleccionada = null) {
                try {
                    const workbook = await this.excelManager.leerArchivoExcel(archivo);
                    const hojas = this.excelManager.obtenerHojasDisponibles(workbook);
                    
                    if (hojas.length === 0) {
                        throw new Error('El archivo Excel no contiene hojas de trabajo');
                    }
                    
                    const hojaNombre = hojaSeleccionada || hojas[0].name;
                    const hoja = workbook.Sheets[hojaNombre];
                    
                    if (!hoja) {
                        throw new Error(`No se encontró la hoja "${hojaNombre}"`);
                    }
                    
                    const datosExcel = this.excelManager.leerDatosDeHoja(hoja);
                    
                    if (datosExcel.length === 0) {
                        throw new Error('No se encontraron datos válidos en la hoja seleccionada');
                    }
                    
                    let registrosImportados = 0;
                    let duplicados = 0;
                    let errores = 0;
                    
                    for (const dato of datosExcel) {
                        try {
                            if (saltarDuplicados) {
                                const existe = await this.verificarPlacaExiste(dato.placa);
                                if (existe) {
                                    duplicados++;
                                    continue;
                                }
                            }
                            
                            await this.insertarPlaca(dato.placa, dato.empresa, dato.asociacion);
                            registrosImportados++;
                            
                        } catch (error) {
                            errores++;
                            console.error(`Error en fila ${dato.rowNumber}:`, error);
                        }
                    }
                    
                    return {
                        registrosImportados,
                        duplicados,
                        errores,
                        totalProcesado: datosExcel.length,
                        datosPreview: datosExcel.slice(0, 5),
                        archivoNombre: archivo.name,
                        hojaUsada: hojaNombre,
                        totalHojas: hojas.length,
                        columnasUsadas: {
                            A: 'PLACA',
                            B: 'EMPRESA', 
                            C: 'ASOCIACION'
                        }
                    };
                    
                } catch (error) {
                    throw error;
                }
            }
            
            async exportarAExcel() {
                const datos = await this.buscarPlacas();
                
                if (datos.length === 0) {
                    throw new Error('No hay datos para exportar');
                }
                
                const datosParaExcel = datos.map(p => ({
                    placa: p.placa,
                    empresa: p.empresa,
                    asociacion: p.asociacion,
                    fechaCreacion: p.fechaCreacion
                }));
                
                const workbook = this.excelManager.crearWorkbookDesdeDatos(datosParaExcel);
                this.excelManager.descargarWorkbook(workbook, `placas_${new Date().toISOString().slice(0, 10)}.xlsx`);
                
                return datos.length;
            }
            
            async obtenerPlacaPorId(id) {
                if (this.useLocalStorage) {
                    const datos = JSON.parse(localStorage.getItem(this.dbName) || '[]');
                    const data = datos.find(p => p.id === id);
                    
                    if (data) {
                        return new Placa(data.id, data.placa, data.empresa, data.asociacion, data.fechaCreacion);
                    }
                    return null;
                } else {
                    return new Promise((resolve, reject) => {
                        const transaction = this.db.transaction([this.storeName], 'readonly');
                        const store = transaction.objectStore(this.storeName);
                        
                        const request = store.get(id);
                        
                        request.onsuccess = () => {
                            const data = request.result;
                            if (data) {
                                resolve(new Placa(data.id, data.placa, data.empresa, data.asociacion, data.fechaCreacion));
                            } else {
                                resolve(null);
                            }
                        };
                        
                        request.onerror = () => {
                            reject(new Error('Error al obtener placa por ID'));
                        };
                    });
                }
            }
        }

        class PlacasDatabaseApp {
            constructor() {
                this.db = new MultiUserDatabase();
                this.archivoImportar = null;
                this.workbookImportar = null;
                this.hojaSeleccionada = null;
                this.init();
            }
            
            async init() {
                await this.db.init();
                this.bindEvents();
                await this.cargarDatos();
                this.setupDragAndDrop();
            }
            
            bindEvents() {
                document.getElementById('btnGuardar').addEventListener('click', () => this.guardarPlaca());
                document.getElementById('btnEditar').addEventListener('click', () => this.editarPlaca());
                document.getElementById('btnLimpiarForm').addEventListener('click', () => this.limpiarFormulario());
                
                document.getElementById('btnExportarExcel').addEventListener('click', () => this.exportarExcel());
                document.getElementById('btnImportarExcel').addEventListener('click', () => this.mostrarModalImportacion());
                document.getElementById('btnEliminarTodos').addEventListener('click', () => this.eliminarTodos());
                
                document.getElementById('btnBuscar').addEventListener('click', () => this.buscarPlacas());
                document.getElementById('btnLimpiarBusqueda').addEventListener('click', () => this.limpiarBusqueda());
                document.getElementById('buscarPlaca').addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') this.buscarPlacas();
                });
                
                document.getElementById('placa').addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') this.guardarPlaca();
                });
                
                document.getElementById('importModalClose').addEventListener('click', () => this.cerrarModalImportacion());
                document.getElementById('importCancel').addEventListener('click', () => this.cerrarModalImportacion());
                document.getElementById('importConfirm').addEventListener('click', () => this.procesarImportacion());
                document.getElementById('removeFile').addEventListener('click', () => this.removerArchivo());
                
                document.getElementById('confirmModalClose').addEventListener('click', () => this.cerrarModalConfirmacion());
                document.getElementById('confirmModalCancel').addEventListener('click', () => this.cerrarModalConfirmacion());
                
                document.getElementById('resultModalClose').addEventListener('click', () => this.cerrarModalResultados());
                document.getElementById('resultModalCloseBtn').addEventListener('click', () => this.cerrarModalResultados());
                
                document.getElementById('sheetSelectModalClose').addEventListener('click', () => this.cerrarModalSeleccionHoja());
                document.getElementById('sheetSelectCancel').addEventListener('click', () => this.cerrarModalSeleccionHoja());
                
                document.getElementById('fileInput').addEventListener('change', (e) => {
                    if (e.target.files.length > 0) {
                        this.seleccionarArchivo(e.target.files[0]);
                    }
                });
            }
            
            setupDragAndDrop() {
                const dropArea = document.getElementById('fileDropArea');
                
                ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
                    dropArea.addEventListener(eventName, (e) => {
                        e.preventDefault();
                        e.stopPropagation();
                    });
                });
                
                ['dragenter', 'dragover'].forEach(eventName => {
                    dropArea.addEventListener(eventName, () => {
                        dropArea.style.borderColor = 'var(--secondary)';
                        dropArea.style.background = '#f0f8ff';
                    });
                });
                
                ['dragleave', 'drop'].forEach(eventName => {
                    dropArea.addEventListener(eventName, () => {
                        dropArea.style.borderColor = '#dee2e6';
                        dropArea.style.background = 'white';
                    });
                });
                
                dropArea.addEventListener('drop', (e) => {
                    const files = e.dataTransfer.files;
                    if (files.length > 0) {
                        this.seleccionarArchivo(files[0]);
                    }
                });
            }
            
            async seleccionarArchivo(archivo) {
                this.archivoImportar = archivo;
                
                document.getElementById('fileName').textContent = archivo.name;
                document.getElementById('fileDetails').innerHTML = `
                    <div>Tamaño: ${this.formatBytes(archivo.size)}</div>
                    <div>Formato: ${this.obtenerExtension(archivo.name).toUpperCase()}</div>
                `;
                
                document.getElementById('fileInfo').style.display = 'block';
                document.getElementById('importConfirm').disabled = true;
                
                await this.mostrarVistaPrevia(archivo);
            }
            
            async mostrarVistaPrevia(archivo) {
                try {
                    const botonConfirmar = document.getElementById('importConfirm');
                    botonConfirmar.innerHTML = '<div class="spinner"></div> CARGANDO...';
                    botonConfirmar.disabled = true;
                    
                    this.workbookImportar = await this.db.excelManager.leerArchivoExcel(archivo);
                    const hojas = this.db.excelManager.obtenerHojasDisponibles(this.workbookImportar);
                    
                    const sheetInfo = document.getElementById('sheetInfo');
                    const sheetNameElement = document.getElementById('sheetName');
                    
                    if (hojas.length > 1) {
                        sheetNameElement.textContent = `Múltiples hojas encontradas (${hojas.length}) - Se usará la primera`;
                        sheetInfo.style.display = 'block';
                        
                        setTimeout(() => {
                            this.mostrarModalSeleccionHoja(hojas);
                        }, 500);
                    } else {
                        sheetNameElement.textContent = `Hoja: "${hojas[0].name}"`;
                        sheetInfo.style.display = 'block';
                        this.hojaSeleccionada = hojas[0].name;
                    }
                    
                    const primeraHoja = hojas[0];
                    const datosPreview = this.db.excelManager.leerDatosDeHoja(primeraHoja.sheet);
                    
                    const previewTableBody = document.getElementById('previewTableBody');
                    previewTableBody.innerHTML = '';
                    
                    if (datosPreview.length === 0) {
                        previewTableBody.innerHTML = `
                            <tr>
                                <td colspan="3" style="text-align: center; padding: 20px; color: #95a5a6;">
                                    No se encontraron datos en la hoja "${primeraHoja.name}"
                                </td>
                            </tr>
                        `;
                    } else {
                        datosPreview.slice(0, 5).forEach(dato => {
                            const tr = document.createElement('tr');
                            tr.innerHTML = `
                                <td style="padding: 6px 8px;">${dato.placa}</td>
                                <td style="padding: 6px 8px;">${dato.empresa}</td>
                                <td style="padding: 6px 8px;">${dato.asociacion}</td>
                            `;
                            previewTableBody.appendChild(tr);
                        });
                        
                        document.getElementById('previewStats').textContent = 
                            `Mostrando ${Math.min(5, datosPreview.length)} de ${datosPreview.length} registros`;
                    }
                    
                    document.getElementById('importPreview').style.display = 'block';
                    document.getElementById('importConfirm').disabled = false;
                    botonConfirmar.innerHTML = '<i class="fas fa-upload"></i> IMPORTAR';
                    
                } catch (error) {
                    console.error('Error mostrando vista previa:', error);
                    document.getElementById('previewStats').textContent = `Error: ${error.message}`;
                    document.getElementById('importPreview').style.display = 'block';
                    document.getElementById('importConfirm').disabled = true;
                    document.getElementById('importConfirm').innerHTML = '<i class="fas fa-exclamation-triangle"></i> ERROR';
                }
            }
            
            mostrarModalSeleccionHoja(hojas) {
                const sheetList = document.getElementById('sheetList');
                sheetList.innerHTML = '';
                
                hojas.forEach((hoja, index) => {
                    const button = document.createElement('button');
                    button.className = 'btn btn-secondary';
                    button.style.width = '100%';
                    button.style.marginBottom = '8px';
                    button.style.textAlign = 'left';
                    button.style.justifyContent = 'flex-start';
                    button.innerHTML = `
                        <i class="fas fa-table"></i> 
                        ${hoja.name} 
                        ${index === 0 ? '<span style="margin-left: 8px; font-size: 12px; opacity: 0.7;">(Predeterminada)</span>' : ''}
                    `;
                    
                    button.addEventListener('click', () => {
                        this.hojaSeleccionada = hoja.name;
                        
                        document.getElementById('sheetName').textContent = `Hoja seleccionada: "${hoja.name}"`;
                        
                        this.cerrarModalSeleccionHoja();
                        
                        this.actualizarVistaPreviaConHoja(hoja);
                    });
                    
                    sheetList.appendChild(button);
                });
                
                document.getElementById('sheetSelectModal').style.display = 'flex';
            }
            
            actualizarVistaPreviaConHoja(hoja) {
                try {
                    const datosPreview = this.db.excelManager.leerDatosDeHoja(hoja.sheet);
                    
                    const previewTableBody = document.getElementById('previewTableBody');
                    previewTableBody.innerHTML = '';
                    
                    if (datosPreview.length === 0) {
                        previewTableBody.innerHTML = `
                            <tr>
                                <td colspan="3" style="text-align: center; padding: 20px; color: #95a5a6;">
                                    No se encontraron datos en la hoja "${hoja.name}"
                                </td>
                            </tr>
                        `;
                    } else {
                        datosPreview.slice(0, 5).forEach(dato => {
                            const tr = document.createElement('tr');
                            tr.innerHTML = `
                                <td style="padding: 6px 8px;">${dato.placa}</td>
                                <td style="padding: 6px 8px;">${dato.empresa}</td>
                                <td style="padding: 6px 8px;">${dato.asociacion}</td>
                            `;
                            previewTableBody.appendChild(tr);
                        });
                        
                        document.getElementById('previewStats').textContent = 
                            `Hoja: "${hoja.name}" - Mostrando ${Math.min(5, datosPreview.length)} de ${datosPreview.length} registros`;
                    }
                    
                } catch (error) {
                    console.error('Error actualizando vista previa:', error);
                }
            }
            
            cerrarModalSeleccionHoja() {
                document.getElementById('sheetSelectModal').style.display = 'none';
            }
            
            removerArchivo() {
                this.archivoImportar = null;
                this.workbookImportar = null;
                this.hojaSeleccionada = null;
                document.getElementById('fileInfo').style.display = 'none';
                document.getElementById('importPreview').style.display = 'none';
                document.getElementById('importConfirm').disabled = true;
                document.getElementById('importConfirm').innerHTML = '<i class="fas fa-upload"></i> IMPORTAR';
                document.getElementById('fileInput').value = '';
            }
            
            formatBytes(bytes, decimals = 2) {
                if (bytes === 0) return '0 Bytes';
                const k = 1024;
                const dm = decimals < 0 ? 0 : decimals;
                const sizes = ['Bytes', 'KB', 'MB', 'GB'];
                const i = Math.floor(Math.log(bytes) / Math.log(k));
                return parseFloat((bytes / Math.pow(k, i)).toFixed(dm)) + ' ' + sizes[i];
            }
            
            obtenerExtension(nombreArchivo) {
                return nombreArchivo.split('.').pop().toLowerCase();
            }
            
            async buscarPlacas() {
                const termino = document.getElementById('buscarPlaca').value.trim();
                await this.cargarDatos(termino);
            }
            
            limpiarBusqueda() {
                document.getElementById('buscarPlaca').value = '';
                this.cargarDatos();
            }
            
            async cargarDatos(termino = null) {
                try {
                    const datos = await this.db.buscarPlacas(termino);
                    this.mostrarDatosEnTabla(datos);
                    await this.actualizarEstadisticas(datos.length, termino);
                } catch (error) {
                    console.error('Error cargando datos:', error);
                    this.mostrarAlerta('Error', 'No se pudieron cargar los datos de la base de datos', 'error');
                }
            }
            
            mostrarDatosEnTabla(datos) {
                const tbody = document.getElementById('placasTableBody');
                tbody.innerHTML = '';
                
                if (datos.length === 0) {
                    const termino = document.getElementById('buscarPlaca').value.trim();
                    tbody.innerHTML = `
                        <tr>
                            <td colspan="5" style="text-align: center; padding: 40px; color: #95a5a6;">
                                <i class="fas fa-database" style="font-size: 40px; margin-bottom: 10px; display: block; opacity: 0.5;"></i>
                                ${termino ? 
                                    `No se encontraron resultados para "${termino}"` : 
                                    'No hay registros de placas. Agrega una nueva placa o importa datos.'}
                            </td>
                        </tr>
                    `;
                    return;
                }
                
                datos.forEach(placa => {
                    const rowData = placa.toTableRow();
                    const fila = document.createElement('tr');
                    
                    fila.innerHTML = `
                        <td style="font-weight: 600; color: var(--dark); font-size: 15px;">${rowData.placa}</td>
                        <td>${rowData.empresa || '<span style="color: #95a5a6; font-style: italic;">-</span>'}</td>
                        <td>${rowData.asociacion || '<span style="color: #95a5a6; font-style: italic;">-</span>'}</td>
                        <td style="color: #95a5a6; font-size: 13px;">${rowData.fechaCreacion}</td>
                        <td>
                            <button class="btn btn-info btn-small" data-id="${rowData.id}" style="padding: 4px 8px; font-size: 12px;">
                                <i class="fas fa-edit"></i> Editar
                            </button>
                            <button class="btn btn-danger btn-small" data-id="${rowData.id}" style="padding: 4px 8px; font-size: 12px;">
                                <i class="fas fa-trash"></i> Eliminar
                            </button>
                        </td>
                    `;
                    
                    tbody.appendChild(fila);
                });
                
                document.querySelectorAll('.btn-info[data-id]').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const id = parseInt(e.target.closest('button').dataset.id);
                        this.cargarParaEditar(id);
                    });
                });
                
                document.querySelectorAll('.btn-danger[data-id]').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const id = parseInt(e.target.closest('button').dataset.id);
                        this.eliminarPlaca(id);
                    });
                });
            }
            
            async actualizarEstadisticas(resultados = 0, termino = null) {
                try {
                    const total = await this.db.contarRegistros();
                    
                    document.getElementById('totalRegistros').textContent = total;
                    document.getElementById('tableInfo').textContent = `${resultados} registros`;
                    
                    let statsText = `Total de registros: ${total}`;
                    if (termino) {
                        statsText = `Búsqueda: "${termino}" - ${resultados} resultados (Total: ${total})`;
                    }
                    document.getElementById('statsText').textContent = statsText;
                } catch (error) {
                    console.error('Error actualizando estadísticas:', error);
                }
            }
            
            async guardarPlaca() {
                const placa = document.getElementById('placa').value.trim();
                const empresa = document.getElementById('empresa').value.trim();
                const asociacion = document.getElementById('asociacion').value.trim();
                
                if (this.db.placaEditando) {
                    await this.actualizarPlacaExistente();
                    return;
                }
                
                if (!placa) {
                    this.mostrarAlerta('Advertencia', 'El campo PLACA es obligatorio', 'warning');
                    document.getElementById('placa').focus();
                    return;
                }
                
                if (!PlacaValidator.validarFormatoPlaca(placa)) {
                    this.mostrarAlerta('Advertencia', 'El formato de la placa no es válido', 'warning');
                    document.getElementById('placa').focus();
                    return;
                }
                
                try {
                    await this.db.insertarPlaca(placa, empresa, asociacion);
                    this.mostrarAlerta('Éxito', 'Placa registrada correctamente', 'success');
                    this.limpiarFormulario();
                    await this.cargarDatos();
                } catch (error) {
                    this.mostrarAlerta('Error', error.message, 'error');
                }
            }
            
            async cargarParaEditar(id) {
                try {
                    const placa = await this.db.obtenerPlacaPorId(id);
                    if (!placa) {
                        this.mostrarAlerta('Error', 'Placa no encontrada', 'error');
                        return;
                    }
                    
                    document.getElementById('placa').value = placa.placa;
                    document.getElementById('empresa').value = placa.empresa;
                    document.getElementById('asociacion').value = placa.asociacion;
                    
                    document.getElementById('btnGuardar').innerHTML = '<i class="fas fa-save"></i> ACTUALIZAR';
                    document.getElementById('btnGuardar').className = 'btn btn-info';
                    
                    this.db.placaEditando = placa;
                    
                    document.getElementById('btnEditar').innerHTML = '<i class="fas fa-times"></i> CANCELAR';
                    document.getElementById('btnEditar').className = 'btn btn-danger';
                    
                    document.getElementById('placa').focus();
                    
                    this.mostrarAlerta('Información', `Editando placa: ${placa.placa}`, 'info');
                    
                } catch (error) {
                    this.mostrarAlerta('Error', 'Error al cargar placa para editar: ' + error.message, 'error');
                }
            }
            
            async editarPlaca() {
                if (this.db.placaEditando) {
                    this.cancelarEdicion();
                    return;
                }
                
                const placaInput = document.getElementById('placa').value.trim();
                if (!placaInput) {
                    this.mostrarAlerta('Advertencia', 'Ingrese una placa para buscar y editar', 'warning');
                    return;
                }
                
                try {
                    const placaEncontrada = await this.db.verificarPlacaExiste(placaInput);
                    if (!placaEncontrada) {
                        this.mostrarAlerta('Error', `No se encontró la placa "${placaInput}"`, 'error');
                        return;
                    }
                    
                    document.getElementById('placa').value = placaEncontrada.placa;
                    document.getElementById('empresa').value = placaEncontrada.empresa;
                    document.getElementById('asociacion').value = placaEncontrada.asociacion;
                    
                    document.getElementById('btnGuardar').innerHTML = '<i class="fas fa-save"></i> ACTUALIZAR';
                    document.getElementById('btnGuardar').className = 'btn btn-info';
                    
                    this.db.placaEditando = new Placa(
                        placaEncontrada.id,
                        placaEncontrada.placa,
                        placaEncontrada.empresa,
                        placaEncontrada.asociacion,
                        placaEncontrada.fechaCreacion
                    );
                    
                    document.getElementById('btnEditar').innerHTML = '<i class="fas fa-times"></i> CANCELAR';
                    document.getElementById('btnEditar').className = 'btn btn-danger';
                    
                    document.getElementById('placa').focus();
                    
                    this.mostrarAlerta('Información', `Editando placa: ${placaEncontrada.placa}`, 'info');
                    
                } catch (error) {
                    this.mostrarAlerta('Error', 'Error al buscar placa para editar: ' + error.message, 'error');
                }
            }
            
            async actualizarPlacaExistente() {
                const placa = document.getElementById('placa').value.trim();
                const empresa = document.getElementById('empresa').value.trim();
                const asociacion = document.getElementById('asociacion').value.trim();
                
                if (!placa) {
                    this.mostrarAlerta('Advertencia', 'El campo PLACA es obligatorio', 'warning');
                    document.getElementById('placa').focus();
                    return;
                }
                
                if (!PlacaValidator.validarFormatoPlaca(placa)) {
                    this.mostrarAlerta('Advertencia', 'El formato de la placa no es válido', 'warning');
                    document.getElementById('placa').focus();
                    return;
                }
                
                try {
                    await this.db.actualizarPlaca(this.db.placaEditando.id, placa, empresa, asociacion);
                    this.mostrarAlerta('Éxito', 'Placa actualizada correctamente', 'success');
                    this.cancelarEdicion();
                    await this.cargarDatos();
                } catch (error) {
                    this.mostrarAlerta('Error', error.message, 'error');
                }
            }
            
            async eliminarPlaca(id) {
                try {
                    this.mostrarModalConfirmacion(
                        'ELIMINAR PLACA',
                        `¿Está seguro de eliminar esta placa?`,
                        async () => {
                            try {
                                await this.db.eliminarPlaca(id);
                                this.mostrarAlerta('Éxito', 'Placa eliminada correctamente', 'success');
                                await this.cargarDatos();
                            } catch (error) {
                                this.mostrarAlerta('Error', error.message, 'error');
                            }
                        }
                    );
                } catch (error) {
                    this.mostrarAlerta('Error', error.message, 'error');
                }
            }
            
            cancelarEdicion() {
                this.limpiarFormulario();
                this.db.placaEditando = null;
                
                document.getElementById('btnGuardar').innerHTML = '<i class="fas fa-save"></i> GUARDAR';
                document.getElementById('btnGuardar').className = 'btn btn-primary';
                document.getElementById('btnEditar').innerHTML = '<i class="fas fa-edit"></i> EDITAR';
                document.getElementById('btnEditar').className = 'btn btn-info';
                
                this.mostrarAlerta('Información', 'Edición cancelada', 'info');
            }
            
            limpiarFormulario() {
                document.getElementById('placa').value = '';
                document.getElementById('empresa').value = '';
                document.getElementById('asociacion').value = '';
                document.getElementById('placa').focus();
            }
            
            async eliminarTodos() {
                try {
                    const total = await this.db.contarRegistros();
                    if (total === 0) {
                        this.mostrarAlerta('Información', 'No hay registros para eliminar', 'info');
                        return;
                    }
                    
                    this.mostrarModalConfirmacion(
                        'ELIMINAR TODOS LOS REGISTROS',
                        `¿Está seguro de eliminar TODOS los registros (${total} en total)?\n\n⚠️ ESTA ACCIÓN NO SE PUEDE DESHACER ⚠️\nSe perderán todos los datos permanentemente.`,
                        async () => {
                            try {
                                await this.db.eliminarTodasPlacas();
                                this.mostrarResultado(
                                    'BASE DE DATOS LIMPIADA',
                                    `✅ Se eliminaron todos los registros (${total}) correctamente.`,
                                    'success'
                                );
                                await this.cargarDatos();
                            } catch (error) {
                                this.mostrarAlerta('Error', 'No se pudieron eliminar todos los registros: ' + error.message, 'error');
                            }
                        }
                    );
                } catch (error) {
                    this.mostrarAlerta('Error', 'No se pudo contar los registros: ' + error.message, 'error');
                }
            }
            
            async exportarExcel() {
                try {
                    const botonExportar = document.getElementById('btnExportarExcel');
                    const textoOriginal = botonExportar.innerHTML;
                    
                    botonExportar.innerHTML = '<div class="spinner"></div> EXPORTANDO...';
                    botonExportar.disabled = true;
                    
                    const exportados = await this.db.exportarAExcel();
                    
                    this.mostrarResultado(
                        'EXPORTACIÓN COMPLETADA',
                        `✅ Se exportaron ${exportados} registros a archivo Excel (.xlsx).\n\nEl archivo se descargará automáticamente con las columnas en el orden correcto:\n\n1. PLACA\n2. EMPRESA\n3. ASOCIACIÓN\n4. FECHA CREACIÓN\n\n📁 Formato: Excel (.xlsx)`,
                        'success'
                    );
                    
                    botonExportar.innerHTML = textoOriginal;
                    botonExportar.disabled = false;
                    
                } catch (error) {
                    this.mostrarAlerta('Error', `No se pudo exportar: ${error.message}`, 'error');
                    document.getElementById('btnExportarExcel').innerHTML = '<i class="fas fa-file-excel"></i> EXPORTAR A EXCEL';
                    document.getElementById('btnExportarExcel').disabled = false;
                }
            }
            
            mostrarModalImportacion() {
                document.getElementById('importModal').style.display = 'flex';
                this.removerArchivo();
            }
            
            cerrarModalImportacion() {
                document.getElementById('importModal').style.display = 'none';
                this.removerArchivo();
            }
            
            async procesarImportacion() {
                if (!this.archivoImportar) {
                    this.mostrarAlerta('Advertencia', 'Debe seleccionar un archivo para importar', 'warning');
                    return;
                }
                
                const saltarDuplicados = document.getElementById('skipDuplicates').checked;
                const botonConfirmar = document.getElementById('importConfirm');
                const textoOriginal = botonConfirmar.innerHTML;
                
                botonConfirmar.innerHTML = '<div class="spinner"></div> IMPORTANDO...';
                botonConfirmar.disabled = true;
                
                try {
                    const resultado = await this.db.importarDesdeExcel(
                        this.archivoImportar, 
                        saltarDuplicados,
                        this.hojaSeleccionada
                    );
                    
                    this.cerrarModalImportacion();
                    
                    let mensaje = `✅ IMPORTACIÓN COMPLETADA\n\n`;
                    mensaje += `✓ Nuevos registros: ${resultado.registrosImportados}\n`;
                    mensaje += `○ Registros duplicados: ${resultado.duplicados}\n`;
                    mensaje += `✗ Errores: ${resultado.errores}\n`;
                    mensaje += `▸ Total procesado: ${resultado.totalProcesado}\n\n`;
                    mensaje += `📊 Información del archivo:\n`;
                    mensaje += `  • Archivo: ${resultado.archivoNombre}\n`;
                    mensaje += `  • Hoja usada: "${resultado.hojaUsada}"\n`;
                    mensaje += `  • Total de hojas: ${resultado.totalHojas}\n\n`;
                    mensaje += `📋 Columnas usadas:\n`;
                    mensaje += `  • Columna A → PLACA\n`;
                    mensaje += `  • Columna B → EMPRESA\n`;
                    mensaje += `  • Columna C → ASOCIACIÓN\n\n`;
                    mensaje += `💾 Los datos se han guardado en la base de datos multi-usuario`;
                    
                    this.mostrarResultado(
                        'RESUMEN DE IMPORTACIÓN',
                        mensaje,
                        'success'
                    );
                    
                    await this.cargarDatos();
                    
                } catch (error) {
                    this.mostrarAlerta('Error', `No se pudo importar el archivo: ${error.message}`, 'error');
                } finally {
                    botonConfirmar.innerHTML = textoOriginal;
                    botonConfirmar.disabled = false;
                }
            }
            
            mostrarModalConfirmacion(titulo, mensaje, callbackConfirmar) {
                document.getElementById('confirmModalTitle').innerHTML = `<i class="fas fa-exclamation-triangle"></i> ${titulo}`;
                document.getElementById('confirmModalMessage').textContent = mensaje;
                
                const modal = document.getElementById('confirmModal');
                modal.style.display = 'flex';
                
                const confirmar = () => {
                    modal.style.display = 'none';
                    document.getElementById('confirmModalConfirm').removeEventListener('click', confirmar);
                    if (callbackConfirmar) callbackConfirmar();
                };
                
                document.getElementById('confirmModalConfirm').addEventListener('click', confirmar);
            }
            
            cerrarModalConfirmacion() {
                document.getElementById('confirmModal').style.display = 'none';
            }
            
            mostrarResultado(titulo, mensaje, tipo = 'info') {
                let icono = 'fas fa-info-circle';
                if (tipo === 'success') icono = 'fas fa-check-circle';
                if (tipo === 'error') icono = 'fas fa-times-circle';
                if (tipo === 'warning') icono = 'fas fa-exclamation-triangle';
                
                document.getElementById('resultModalTitle').innerHTML = `<i class="${icono}"></i> ${titulo}`;
                document.getElementById('resultModalMessage').textContent = mensaje;
                
                document.getElementById('resultModal').style.display = 'flex';
            }
            
            cerrarModalResultados() {
                document.getElementById('resultModal').style.display = 'none';
            }
            
            mostrarAlerta(titulo, mensaje, tipo = 'info') {
                const alerta = document.createElement('div');
                
                let clase = 'alert-info';
                switch(tipo) {
                    case 'success': clase = 'alert-success'; break;
                    case 'error': clase = 'alert-error'; break;
                    case 'warning': clase = 'alert-warning'; break;
                }
                
                alerta.className = `alert ${clase}`;
                
                let icono = 'fas fa-info-circle';
                if (tipo === 'success') icono = 'fas fa-check-circle';
                if (tipo === 'error') icono = 'fas fa-times-circle';
                if (tipo === 'warning') icono = 'fas fa-exclamation-triangle';
                
                alerta.innerHTML = `
                    <i class="${icono}" style="font-size: 18px; margin-top: 2px;"></i>
                    <div>
                        <div style="font-size: 14px; margin-bottom: 4px; font-weight: 700;">${titulo}</div>
                        <div style="font-size: 13px; opacity: 0.9;">${mensaje}</div>
                    </div>
                `;
                
                document.body.appendChild(alerta);
                
                setTimeout(() => {
                    alerta.style.animation = 'slideOutAlert 0.3s ease-out';
                    setTimeout(() => {
                        if (alerta.parentNode) {
                            alerta.parentNode.removeChild(alerta);
                        }
                    }, 300);
                }, 4000);
            }
        }

        // ============================================
        // MÓDULO PRINCIPAL DEL SISTEMA DE VERIFICACIÓN
        // ============================================
        class SistemaVerificacionPlacas {
            constructor(usuarioActual) {
                this.usuarioActual = usuarioActual;
                this.datosActuales = null;
                this.placaEncontrada = null;
                this.observacionSeleccionada = null;
                this.placasEnRevision = {};
                this.registrosObservadosGlobales = [];
                this.registrosAceptadosGlobales = [];
                this.usuarioSeleccionado = null;
                this.init();
            }
            
            init() {
                this.cargarObservacionesGlobales();
                this.cargarAceptadosGlobales();
                this.registrosAceptados = [];
                this.registrosObservados = [];
                
                this.bindEvents();
                this.cargarRegistrosDesdeLocalStorage();
                this.actualizarContadores();
                this.mostrarRegistrosAceptados();
                this.mostrarRegistrosObservados();
                
                this.configurarTabs();
            }
            
            configurarTabs() {
                document.querySelectorAll('.tab').forEach(tab => {
                    tab.addEventListener('click', () => {
                        const tabId = tab.dataset.tab;
                        this.cambiarPestana(tabId);
                    });
                });
            }
            
            cambiarPestana(tabId) {
                if (this.usuarioActual.tipo === 'usuario' && tabId === 'database') {
                    this.mostrarAlerta('Acceso restringido', 'Los usuarios normales no tienen acceso a la base de datos', 'warning');
                    return;
                }
                
                document.querySelectorAll('.tab').forEach(t => {
                    t.classList.remove('active');
                });
                document.querySelectorAll('.tab-content').forEach(c => {
                    c.classList.remove('active');
                });
                
                const tabElement = document.querySelector(`.tab[data-tab="${tabId}"]`);
                if (tabElement) {
                    tabElement.classList.add('active');
                    document.getElementById(`${tabId}Tab`).classList.add('active');
                }
            }
            
            bindEvents() {
                document.getElementById('btnCheck').addEventListener('click', () => {
                    this.procesarDatos();
                });
                
                document.getElementById('btnRegistrar').addEventListener('click', () => {
                    this.registrarAceptado();
                });
                
                document.getElementById('btnObservar').addEventListener('click', () => {
                    this.mostrarModalObservaciones();
                });
                
                document.getElementById('btnLimpiarDatos').addEventListener('click', () => {
                    this.limpiarTextarea();
                });
                
                document.getElementById('btnExportAccepted').addEventListener('click', () => {
                    this.exportarAExcel('aceptados');
                });
                
                document.getElementById('btnExportObserved').addEventListener('click', () => {
                    this.exportarAExcel('observados');
                });
                
                document.getElementById('btnDeleteAccepted').addEventListener('click', () => {
                    if (this.usuarioActual.tipo === 'administrador' || this.usuarioActual.tipo === 'creador') {
                        this.eliminarTodosRegistros('aceptados');
                    } else {
                        this.mostrarAlerta('Error', 'No tiene permisos para eliminar registros', 'error');
                    }
                });
                
                document.getElementById('btnDeleteObserved').addEventListener('click', () => {
                    if (this.usuarioActual.tipo === 'administrador' || this.usuarioActual.tipo === 'creador') {
                        this.eliminarTodosRegistrosObservados();
                    } else {
                        this.mostrarAlerta('Error', 'No tiene permisos para eliminar registros', 'error');
                    }
                });
                
                document.querySelectorAll('.observation-option').forEach(option => {
                    option.addEventListener('click', (e) => {
                        this.seleccionarObservacion(e.target.closest('.observation-option'));
                    });
                });
                
                document.getElementById('confirmObservation').addEventListener('click', () => {
                    this.confirmarObservacion();
                });
                
                document.getElementById('cancelObservation').addEventListener('click', () => {
                    this.ocultarModalObservaciones();
                });
                
                document.getElementById('inputDatos').addEventListener('keydown', (e) => {
                    if (e.key === 'Enter' && e.ctrlKey) {
                        e.preventDefault();
                        this.procesarDatos();
                    }
                });
            }
            
            configurarSelectorUsuarios() {
                const userSelector = document.getElementById('userSelector');
                const btnExportSelectedUser = document.getElementById('btnExportSelectedUser');
                
                if (userSelector) {
                    userSelector.addEventListener('change', (e) => {
                        this.usuarioSeleccionado = e.target.value;
                        if (this.usuarioSeleccionado === 'current') {
                            this.mostrarRegistrosAceptados();
                            btnExportSelectedUser.style.display = 'none';
                        } else {
                            this.mostrarRegistrosOtroUsuario(this.usuarioSeleccionado);
                            btnExportSelectedUser.style.display = 'flex';
                        }
                    });
                }
            }
            
            mostrarRegistrosOtroUsuario(username) {
                const keyAceptados = `registrosAceptados_${username}`;
                const registrosAceptadosStr = localStorage.getItem(keyAceptados);
                const registrosAceptados = registrosAceptadosStr ? JSON.parse(registrosAceptadosStr) : [];
                
                const acceptedList = document.getElementById('acceptedList');
                
                if (registrosAceptados.length === 0) {
                    acceptedList.innerHTML = `
                        <div class="no-records">
                            <i class="fas fa-user"></i>
                            <h3>Usuario: ${username}</h3>
                            <p>Este usuario no tiene registros aceptados</p>
                        </div>
                    `;
                    document.getElementById('acceptedCount').textContent = '0';
                    return;
                }
                
                let html = '';
                registrosAceptados.forEach((registro, index) => {
                    const puedeEliminar = this.usuarioActual.tipo === 'creador' || this.usuarioActual.tipo === 'administrador';
                    
                    html += `
                        <div class="record-item accepted" data-index="${index}">
                            ${puedeEliminar ? `
                                <button class="delete-record-btn" onclick="sistema.eliminarRegistroOtroUsuario('${username}', ${index})">
                                    <i class="fas fa-times"></i>
                                </button>
                            ` : ''}
                            <div class="record-placa">${registro.nroPlaca}</div>
                            <div class="record-details">
                                <strong>Trámite:</strong> ${registro.numeroTramite}<br>
                                <strong>Empresa:</strong> ${registro.empresa}<br>
                                <strong>Estado:</strong> ${registro.estadoTramite}<br>
                                <strong>Tipo HR:</strong> ${registro.tipoHR}<br>
                                <strong>Fecha:</strong> ${registro.fechaRegistro}<br>
                                <strong>Usuario:</strong> ${registro.usuarioRegistro || username}
                            </div>
                        </div>
                    `;
                });
                
                acceptedList.innerHTML = html;
                document.getElementById('acceptedCount').textContent = registrosAceptados.length;
            }
            
            eliminarRegistroOtroUsuario(username, index) {
                if (this.usuarioActual.tipo !== 'creador' && this.usuarioActual.tipo !== 'administrador') {
                    this.mostrarAlerta('Error', 'No tiene permisos para eliminar registros', 'error');
                    return;
                }
                
                if (confirm(`¿Está seguro de eliminar este registro del usuario ${username}?`)) {
                    const keyAceptados = `registrosAceptados_${username}`;
                    const registrosAceptadosStr = localStorage.getItem(keyAceptados);
                    const registrosAceptados = registrosAceptadosStr ? JSON.parse(registrosAceptadosStr) : [];
                    
                    if (index >= 0 && index < registrosAceptados.length) {
                        registrosAceptados.splice(index, 1);
                        
                        localStorage.setItem(keyAceptados, JSON.stringify(registrosAceptados));
                        
                        this.mostrarRegistrosOtroUsuario(username);
                        
                        this.mostrarAlerta('Éxito', 'Registro eliminado correctamente', 'success');
                    }
                }
            }
            
            exportarRegistrosUsuario(username) {
                try {
                    const keyAceptados = `registrosAceptados_${username}`;
                    const registrosAceptadosStr = localStorage.getItem(keyAceptados);
                    const registrosAceptados = registrosAceptadosStr ? JSON.parse(registrosAceptadosStr) : [];
                    
                    if (registrosAceptados.length === 0) {
                        this.mostrarAlerta('Advertencia', `El usuario ${username} no tiene registros aceptados`, 'warning');
                        return;
                    }
                    
                    const datos = registrosAceptados.map(registro => [
                        registro.nroPlaca,
                        registro.numeroTramite,
                        registro.empresa,
                        registro.estadoTramite,
                        registro.tipoHR,
                        registro.fechaRegistro,
                        registro.usuarioRegistro || username
                    ]);
                    
                    const headers = [
                        'PLACA',
                        'N° TRÁMITE',
                        'EMPRESA',
                        'ESTADO',
                        'TIPO HR',
                        'FECHA REGISTRO',
                        'USUARIO'
                    ];
                    
                    datos.unshift(headers);
                    
                    const worksheet = XLSX.utils.aoa_to_sheet(datos);
                    const workbook = XLSX.utils.book_new();
                    XLSX.utils.book_append_sheet(workbook, worksheet, `Registros_${username}`);
                    
                    const fecha = new Date().toISOString().slice(0, 10);
                    const nombreArchivo = `registros_${username}_${fecha}.xlsx`;
                    
                    XLSX.writeFile(workbook, nombreArchivo);
                    
                    this.mostrarAlerta('Éxito', `Se exportaron ${registrosAceptados.length} registros de ${username}`, 'success');
                    
                } catch (error) {
                    console.error('Error exportando registros de usuario:', error);
                    this.mostrarAlerta('Error', 'No se pudo exportar los registros: ' + error.message, 'error');
                }
            }
            
            procesarDatos() {
                const texto = document.getElementById('inputDatos').value.trim();
                
                if (!texto) {
                    this.mostrarAlerta('Advertencia', 'Ingrese datos para procesar', 'warning');
                    return;
                }
                
                try {
                    this.datosActuales = null;
                    this.placaEncontrada = null;
                    
                    let datosProcesados = null;
                    
                    if (texto.includes('\n')) {
                        datosProcesados = this.procesarFormatoDosLineas(texto);
                    } else {
                        datosProcesados = this.procesarFormatoUnaLinea(texto);
                    }
                    
                    if (!datosProcesados) {
                        this.mostrarAlerta('Error', 'Formato no reconocido. Use los ejemplos como referencia', 'error');
                        return;
                    }
                    
                    this.datosActuales = datosProcesados;
                    
                    if (this.placasEnRevision[this.datosActuales.nroPlaca] && 
                        this.placasEnRevision[this.datosActuales.nroPlaca] !== this.usuarioActual.username) {
                        this.mostrarAlerta(
                            'Placa en revisión', 
                            `La placa ${this.datosActuales.nroPlaca} está siendo revisada por ${this.placasEnRevision[this.datosActuales.nroPlaca]}`,
                            'info'
                        );
                    }
                    
                    const placaObservada = this.verificarPlacaObservada(this.datosActuales.nroPlaca);
                    if (placaObservada) {
                        this.mostrarAlerta(
                            'Placa ya observada', 
                            `Esta placa ya fue observada como: ${placaObservada.observacion}`,
                            'warning'
                        );
                    }
                    
                    const placaAceptada = this.verificarPlacaAceptadaGlobalmente(this.datosActuales.nroPlaca);
                    if (placaAceptada) {
                        this.mostrarAlerta(
                            'Placa ya aceptada', 
                            `Esta placa ya fue aceptada por: ${placaAceptada.usuarioRegistro}`,
                            'warning'
                        );
                        document.getElementById('btnRegistrar').disabled = true;
                    }
                    
                    this.placasEnRevision[this.datosActuales.nroPlaca] = this.usuarioActual.username;
                    
                    document.getElementById('estadoTramite').textContent = this.datosActuales.estadoTramite;
                    document.getElementById('estadoTramite').className = 'display-value';
                    
                    document.getElementById('numeroTramite').textContent = this.datosActuales.numeroTramite;
                    document.getElementById('numeroTramite').className = 'display-value';
                    
                    document.getElementById('tipoHR').textContent = this.datosActuales.tipoHR;
                    document.getElementById('tipoHR').className = 'display-value';
                    
                    document.getElementById('nroPlaca').textContent = this.datosActuales.nroPlaca;
                    document.getElementById('nroPlaca').className = 'display-value';
                    
                    this.verificarPlacaEnBaseDeDatos(this.datosActuales.nroPlaca);
                    
                } catch (error) {
                    console.error('Error procesando datos:', error);
                    this.mostrarAlerta('Error', 'Error al procesar los datos: ' + error.message, 'error');
                }
            }
            
            procesarFormatoDosLineas(texto) {
                const lineas = texto.split('\n').map(linea => linea.trim()).filter(linea => linea !== '');
                
                if (lineas.length < 2) {
                    return null;
                }
                
                const estadoTramite = lineas[0];
                const segundaLinea = lineas[1];
                
                const datosSegundaLinea = segundaLinea.split(/\t|\s{2,}/).filter(d => d.trim() !== '');
                
                if (datosSegundaLinea.length < 5) {
                    return null;
                }
                
                return {
                    estadoTramite: estadoTramite,
                    numeroTramite: datosSegundaLinea[0],
                    tipoHR: datosSegundaLinea[1],
                    usuario: datosSegundaLinea[2],
                    nroPlaca: datosSegundaLinea[3],
                    fechaEstado: datosSegundaLinea[4],
                    formato: 'dos-lineas'
                };
            }
            
            procesarFormatoUnaLinea(texto) {
                const datos = texto.split(/\t|\s{2,}/).filter(d => d.trim() !== '');
                
                if (datos.length < 6) {
                    return null;
                }
                
                return {
                    estadoTramite: datos[0],
                    numeroTramite: datos[1],
                    tipoHR: datos[2],
                    usuario: datos[3],
                    nroPlaca: datos[4],
                    fechaEstado: datos[5],
                    formato: 'una-linea'
                };
            }
            
            async verificarPlacaEnBaseDeDatos(placa) {
                try {
                    const placaNormalizada = placa.toUpperCase().replace(/[-\s]/g, '');
                    
                    if (!window.placasDatabaseApp) {
                        throw new Error('Base de datos no inicializada');
                    }
                    
                    const datos = await window.placasDatabaseApp.db.buscarPlacas(placa);
                    
                    this.placaEncontrada = datos.find(item => {
                        const itemPlaca = item.placa ? item.placa.toUpperCase().replace(/[-\s]/g, '') : '';
                        return itemPlaca === placaNormalizada;
                    });
                    
                    const placaBox = document.getElementById('placaBox');
                    const placaStatus = document.getElementById('placaStatus');
                    const empresaBox = document.getElementById('empresaBox');
                    const empresaNombre = document.getElementById('empresaNombre');
                    
                    if (this.placaEncontrada) {
                        placaBox.className = 'status-box placa-found';
                        placaStatus.textContent = '✓ ENCONTRADA';
                        placaStatus.style.color = 'var(--success)';
                        
                        empresaBox.className = 'status-box empresa-found';
                        empresaNombre.textContent = this.placaEncontrada.empresa || 'No especificada';
                        
                        document.getElementById('btnRegistrar').disabled = false;
                        document.getElementById('btnObservar').disabled = false;
                        
                    } else {
                        placaBox.className = 'status-box placa-notfound';
                        placaStatus.textContent = '✗ NO ENCONTRADA';
                        placaStatus.style.color = 'var(--danger)';
                        
                        empresaBox.className = 'status-box empresa-notfound';
                        empresaNombre.textContent = 'NO REGISTRADA';
                        
                        document.getElementById('btnRegistrar').disabled = true;
                        document.getElementById('btnObservar').disabled = false;
                    }
                    
                } catch (error) {
                    console.error('Error verificando placa:', error);
                    
                    const placaBox = document.getElementById('placaBox');
                    const placaStatus = document.getElementById('placaStatus');
                    
                    placaBox.className = 'status-box placa-notfound';
                    placaStatus.textContent = 'ERROR EN CONSULTA';
                    placaStatus.style.color = 'var(--danger)';
                    
                    document.getElementById('btnRegistrar').disabled = true;
                    document.getElementById('btnObservar').disabled = true;
                }
            }
            
            mostrarModalObservaciones() {
                if (!this.datosActuales) {
                    this.mostrarAlerta('Error', 'No hay datos para observar', 'error');
                    return;
                }
                
                this.observacionSeleccionada = null;
                document.querySelectorAll('.observation-option').forEach(option => {
                    option.classList.remove('selected');
                });
                document.getElementById('observationModal').style.display = 'flex';
            }
            
            ocultarModalObservaciones() {
                document.getElementById('observationModal').style.display = 'none';
                this.observacionSeleccionada = null;
            }
            
            seleccionarObservacion(element) {
                document.querySelectorAll('.observation-option').forEach(option => {
                    option.classList.remove('selected');
                });
                element.classList.add('selected');
                this.observacionSeleccionada = element.dataset.observation;
            }
            
            confirmarObservacion() {
                if (!this.observacionSeleccionada) {
                    this.mostrarAlerta('Advertencia', 'Seleccione un tipo de observación', 'warning');
                    return;
                }
                
                this.registrarObservado();
                this.ocultarModalObservaciones();
            }
            
            registrarAceptado() {
                if (!this.datosActuales) {
                    this.mostrarAlerta('Error', 'No hay datos para registrar como aceptado', 'error');
                    return;
                }
                
                const placaAceptadaGlobal = this.verificarPlacaAceptadaGlobalmente(this.datosActuales.nroPlaca);
                if (placaAceptadaGlobal) {
                    this.mostrarAlerta('Error', 'Esta placa ya fue aceptada por otro usuario', 'error');
                    return;
                }
                
                const registro = {
                    ...this.datosActuales,
                    empresa: this.placaEncontrada ? (this.placaEncontrada.empresa || 'No especificada') : 'No encontrada',
                    fechaRegistro: new Date().toLocaleString('es-ES', {
                        year: 'numeric',
                        month: '2-digit',
                        day: '2-digit',
                        hour: '2-digit',
                        minute: '2-digit',
                        second: '2-digit'
                    }),
                    timestamp: Date.now(),
                    tipo: 'aceptado',
                    usuarioRegistro: this.usuarioActual.username
                };
                
                delete registro.usuario;
                delete registro.fechaEstado;
                delete registro.formato;
                
                this.registrosAceptados.unshift(registro);
                
                this.agregarAceptadoGlobal(registro);
                
                this.guardarRegistrosEnLocalStorage();
                this.guardarAceptadosGlobales();
                
                delete this.placasEnRevision[this.datosActuales.nroPlaca];
                
                this.actualizarContadores();
                this.mostrarRegistrosAceptados();
                this.limpiarFormulario();
                
                this.mostrarAlerta('Éxito', 'Registro ACEPTADO guardado correctamente', 'success');
            }
            
            agregarAceptadoGlobal(registro) {
                if (registro.estadoTramite === 'Subsanado P. A.') {
                    this.registrosAceptadosGlobales.push({
                        nroPlaca: registro.nroPlaca,
                        numeroTramite: registro.numeroTramite,
                        empresa: registro.empresa,
                        estadoTramite: registro.estadoTramite,
                        tipoHR: registro.tipoHR,
                        fechaRegistro: registro.fechaRegistro,
                        usuarioRegistro: registro.usuarioRegistro,
                        timestamp: registro.timestamp
                    });
                } else {
                    const index = this.registrosAceptadosGlobales.findIndex(
                        item => item.nroPlaca === registro.nroPlaca
                    );
                    
                    if (index === -1) {
                        this.registrosAceptadosGlobales.push({
                            nroPlaca: registro.nroPlaca,
                            numeroTramite: registro.numeroTramite,
                            empresa: registro.empresa,
                            estadoTramite: registro.estadoTramite,
                            tipoHR: registro.tipoHR,
                            fechaRegistro: registro.fechaRegistro,
                            usuarioRegistro: registro.usuarioRegistro,
                            timestamp: registro.timestamp
                        });
                    }
                }
            }
            
            verificarPlacaAceptadaGlobalmente(placa) {
                if (this.datosActuales && this.datosActuales.estadoTramite === 'Subsanado P. A.') {
                    return null;
                }
                return this.registrosAceptadosGlobales.find(item => item.nroPlaca === placa);
            }
            
            cargarAceptadosGlobales() {
                try {
                    const aceptadosGlobales = localStorage.getItem('aceptados_globales');
                    this.registrosAceptadosGlobales = aceptadosGlobales ? JSON.parse(aceptadosGlobales) : [];
                } catch (error) {
                    console.error('Error cargando aceptados globales:', error);
                    this.registrosAceptadosGlobales = [];
                }
            }
            
            guardarAceptadosGlobales() {
                try {
                    localStorage.setItem('aceptados_globales', JSON.stringify(this.registrosAceptadosGlobales));
                } catch (error) {
                    console.error('Error guardando aceptados globales:', error);
                }
            }
            
            registrarObservado() {
                if (!this.datosActuales) {
                    this.mostrarAlerta('Error', 'No hay datos para registrar como observado', 'error');
                    return;
                }
                
                if (!this.observacionSeleccionada) {
                    this.mostrarAlerta('Error', 'Seleccione un tipo de observación', 'error');
                    return;
                }
                
                const registro = {
                    ...this.datosActuales,
                    empresa: this.placaEncontrada ? (this.placaEncontrada.empresa || 'No especificada') : 'NO REGISTRADA',
                    observacion: this.observacionSeleccionada,
                    fechaRegistro: new Date().toLocaleString('es-ES', {
                        year: 'numeric',
                        month: '2-digit',
                        day: '2-digit',
                        hour: '2-digit',
                        minute: '2-digit',
                        second: '2-digit'
                    }),
                    timestamp: Date.now(),
                    tipo: 'observado',
                    usuarioRegistro: this.usuarioActual.username
                };
                
                delete registro.usuario;
                delete registro.fechaEstado;
                delete registro.formato;
                
                this.agregarObservacionGlobal(registro);
                
                this.guardarObservacionesGlobales();
                
                delete this.placasEnRevision[this.datosActuales.nroPlaca];
                
                this.actualizarContadores();
                this.mostrarRegistrosObservados();
                this.limpiarFormulario();
                
                this.mostrarAlerta('Éxito', `Registro OBSERVADO (${this.observacionSeleccionada}) guardado correctamente`, 'success');
            }
            
            agregarObservacionGlobal(registro) {
                const index = this.registrosObservadosGlobales.findIndex(
                    obs => obs.nroPlaca === registro.nroPlaca
                );
                
                if (index !== -1) {
                    this.registrosObservadosGlobales[index] = {
                        ...this.registrosObservadosGlobales[index],
                        observacion: registro.observacion,
                        numeroTramite: registro.numeroTramite,
                        empresa: registro.empresa,
                        estadoTramite: registro.estadoTramite,
                        tipoHR: registro.tipoHR,
                        fechaRegistro: registro.fechaRegistro,
                        usuarioRegistro: registro.usuarioRegistro,
                        timestamp: registro.timestamp
                    };
                } else {
                    this.registrosObservadosGlobales.push({
                        nroPlaca: registro.nroPlaca,
                        observacion: registro.observacion,
                        numeroTramite: registro.numeroTramite,
                        empresa: registro.empresa,
                        estadoTramite: registro.estadoTramite,
                        tipoHR: registro.tipoHR,
                        fechaRegistro: registro.fechaRegistro,
                        usuarioRegistro: registro.usuarioRegistro,
                        timestamp: registro.timestamp
                    });
                }
            }
            
            verificarPlacaObservada(placa) {
                return this.registrosObservadosGlobales.find(obs => obs.nroPlaca === placa);
            }
            
            cargarObservacionesGlobales() {
                try {
                    const observaciones = localStorage.getItem('observaciones_globales');
                    this.registrosObservadosGlobales = observaciones ? JSON.parse(observaciones) : [];
                } catch (error) {
                    console.error('Error cargando observaciones globales:', error);
                    this.registrosObservadosGlobales = [];
                }
            }
            
            guardarObservacionesGlobales() {
                try {
                    localStorage.setItem('observaciones_globales', JSON.stringify(this.registrosObservadosGlobales));
                } catch (error) {
                    console.error('Error guardando observaciones globales:', error);
                }
            }
            
            eliminarTodosRegistrosObservados() {
                if (this.usuarioActual.tipo !== 'administrador' && this.usuarioActual.tipo !== 'creador') {
                    this.mostrarAlerta('Error', 'No tiene permisos para eliminar registros', 'error');
                    return;
                }
                
                const cantidad = this.registrosObservadosGlobales.length;
                
                if (cantidad === 0) {
                    this.mostrarAlerta('Información', 'No hay registros observados para eliminar', 'info');
                    return;
                }
                
                if (confirm(`¿Está seguro de eliminar TODOS los registros observados (${cantidad} en total)?\n\n⚠️ ESTA ACCIÓN NO SE PUEDE DESHACER ⚠️`)) {
                    this.registrosObservadosGlobales = [];
                    this.guardarObservacionesGlobales();
                    
                    this.actualizarContadores();
                    this.mostrarRegistrosObservados();
                    
                    this.mostrarAlerta('Éxito', `Se eliminaron ${cantidad} registros observados`, 'success');
                }
            }
            
            limpiarTextarea() {
                document.getElementById('inputDatos').value = '';
                document.getElementById('inputDatos').focus();
                this.mostrarAlerta('Información', 'Área de texto limpiada', 'info');
            }
            
            limpiarFormulario() {
                document.getElementById('inputDatos').value = '';
                
                document.getElementById('estadoTramite').textContent = '---';
                document.getElementById('estadoTramite').className = 'display-value empty';
                
                document.getElementById('numeroTramite').textContent = '---';
                document.getElementById('numeroTramite').className = 'display-value empty';
                
                document.getElementById('tipoHR').textContent = '---';
                document.getElementById('tipoHR').className = 'display-value empty';
                
                document.getElementById('nroPlaca').textContent = '---';
                document.getElementById('nroPlaca').className = 'display-value empty';
                
                document.getElementById('placaBox').className = 'status-box placa-default';
                document.getElementById('placaStatus').textContent = '---';
                
                document.getElementById('empresaBox').className = 'status-box empresa-default';
                document.getElementById('empresaNombre').textContent = '---';
                
                document.getElementById('btnRegistrar').disabled = true;
                document.getElementById('btnObservar').disabled = true;
                
                this.datosActuales = null;
                this.placaEncontrada = null;
                this.observacionSeleccionada = null;
            }
            
            cargarRegistrosDesdeLocalStorage() {
                try {
                    const keyAceptados = `registrosAceptados_${this.usuarioActual.username}`;
                    const keyObservados = `registrosObservados_${this.usuarioActual.username}`;
                    
                    const registrosAceptados = localStorage.getItem(keyAceptados);
                    const registrosObservados = localStorage.getItem(keyObservados);
                    
                    this.registrosAceptados = registrosAceptados ? JSON.parse(registrosAceptados) : [];
                    this.registrosObservados = registrosObservados ? JSON.parse(registrosObservados) : [];
                } catch (error) {
                    console.error('Error cargando registros:', error);
                    this.registrosAceptados = [];
                    this.registrosObservados = [];
                }
            }
            
            guardarRegistrosEnLocalStorage() {
                try {
                    const keyAceptados = `registrosAceptados_${this.usuarioActual.username}`;
                    const keyObservados = `registrosObservados_${this.usuarioActual.username}`;
                    
                    localStorage.setItem(keyAceptados, JSON.stringify(this.registrosAceptados));
                    localStorage.setItem(keyObservados, JSON.stringify(this.registrosObservados));
                } catch (error) {
                    console.error('Error guardando registros:', error);
                }
            }
            
            actualizarContadores() {
                document.getElementById('acceptedCount').textContent = this.registrosAceptados.length;
                document.getElementById('observedCount').textContent = this.registrosObservadosGlobales.length;
            }
            
            mostrarRegistrosAceptados() {
                const acceptedList = document.getElementById('acceptedList');
                
                if (this.registrosAceptados.length === 0) {
                    acceptedList.innerHTML = `
                        <div class="no-records">
                            <i class="fas fa-check-circle"></i>
                            <h3>No hay registros aceptados</h3>
                            <p>Los registros aceptados aparecerán aquí</p>
                        </div>
                    `;
                    return;
                }
                
                let html = '';
                this.registrosAceptados.forEach((registro, index) => {
                    const puedeEliminar = this.usuarioActual.tipo === 'administrador' || this.usuarioActual.tipo === 'creador';
                    
                    html += `
                        <div class="record-item accepted" data-index="${index}" data-tipo="aceptado">
                            ${puedeEliminar ? `
                                <button class="delete-record-btn" onclick="sistema.eliminarRegistroIndividual(${index}, 'aceptado')">
                                    <i class="fas fa-times"></i>
                                </button>
                            ` : ''}
                            <div class="record-placa">${registro.nroPlaca}</div>
                            <div class="record-details">
                                <strong>Trámite:</strong> ${registro.numeroTramite}<br>
                                <strong>Empresa:</strong> ${registro.empresa}<br>
                                <strong>Estado:</strong> ${registro.estadoTramite}<br>
                                <strong>Tipo HR:</strong> ${registro.tipoHR}<br>
                                <strong>Fecha:</strong> ${registro.fechaRegistro}<br>
                                <strong>Usuario:</strong> ${registro.usuarioRegistro || this.usuarioActual.username}
                            </div>
                        </div>
                    `;
                });
                
                acceptedList.innerHTML = html;
                document.getElementById('acceptedCount').textContent = this.registrosAceptados.length;
            }
            
            mostrarRegistrosObservados() {
                const observedList = document.getElementById('observedList');
                
                if (this.registrosObservadosGlobales.length === 0) {
                    observedList.innerHTML = `
                        <div class="no-records">
                            <i class="fas fa-eye"></i>
                            <h3>No hay registros observados</h3>
                            <p>Los registros observados compartidos aparecerán aquí</p>
                        </div>
                    `;
                    return;
                }
                
                let html = '';
                this.registrosObservadosGlobales.forEach((registro, index) => {
                    const puedeEliminar = this.usuarioActual.tipo === 'administrador' || this.usuarioActual.tipo === 'creador';
                    
                    html += `
                        <div class="record-item observed" data-index="${index}">
                            ${puedeEliminar ? `
                                <button class="delete-record-btn" onclick="sistema.eliminarObservacionGlobal(${index})">
                                    <i class="fas fa-times"></i>
                                </button>
                            ` : ''}
                            <div class="record-placa">${registro.nroPlaca}</div>
                            <div class="record-details">
                                <strong>Observación:</strong> ${registro.observacion}<br>
                                <strong>Trámite:</strong> ${registro.numeroTramite || 'N/A'}<br>
                                <strong>Fecha:</strong> ${registro.fechaRegistro}<br>
                                <strong>Reportado por:</strong> ${registro.usuarioRegistro}
                                ${registro.empresa ? `<br><strong>Empresa:</strong> ${registro.empresa}` : ''}
                                ${registro.estadoTramite ? `<br><strong>Estado:</strong> ${registro.estadoTramite}` : ''}
                                ${registro.tipoHR ? `<br><strong>Tipo HR:</strong> ${registro.tipoHR}` : ''}
                            </div>
                        </div>
                    `;
                });
                
                observedList.innerHTML = html;
                document.getElementById('observedCount').textContent = this.registrosObservadosGlobales.length;
            }
            
            eliminarObservacionGlobal(index) {
                if (this.usuarioActual.tipo !== 'administrador' && this.usuarioActual.tipo !== 'creador') {
                    this.mostrarAlerta('Error', 'No tiene permisos para eliminar observaciones', 'error');
                    return;
                }
                
                if (confirm('¿Está seguro de eliminar esta observación?')) {
                    this.registrosObservadosGlobales.splice(index, 1);
                    this.guardarObservacionesGlobales();
                    this.mostrarRegistrosObservados();
                    this.actualizarContadores();
                    this.mostrarAlerta('Éxito', 'Observación eliminada', 'success');
                }
            }
            
            eliminarRegistroIndividual(index, tipo) {
                if (this.usuarioActual.tipo !== 'administrador' && this.usuarioActual.tipo !== 'creador') {
                    this.mostrarAlerta('Error', 'No tiene permisos para eliminar registros', 'error');
                    return;
                }
                
                if (confirm(`¿Está seguro de eliminar este registro ${tipo === 'aceptado' ? 'aceptado' : 'observado'}?`)) {
                    if (tipo === 'aceptado') {
                        const registroEliminado = this.registrosAceptados[index];
                        
                        const indexGlobal = this.registrosAceptadosGlobales.findIndex(
                            item => item.nroPlaca === registroEliminado.nroPlaca &&
                                   item.usuarioRegistro === registroEliminado.usuarioRegistro
                        );
                        if (indexGlobal !== -1) {
                            this.registrosAceptadosGlobales.splice(indexGlobal, 1);
                            this.guardarAceptadosGlobales();
                        }
                        
                        this.registrosAceptados.splice(index, 1);
                    } else {
                        this.registrosObservados.splice(index, 1);
                    }
                    
                    this.guardarRegistrosEnLocalStorage();
                    this.actualizarContadores();
                    
                    if (tipo === 'aceptado') {
                        this.mostrarRegistrosAceptados();
                    } else {
                        this.mostrarRegistrosObservados();
                    }
                    
                    this.mostrarAlerta('Éxito', 'Registro eliminado correctamente', 'success');
                }
            }
            
            eliminarTodosRegistros(tipo) {
                if (this.usuarioActual.tipo !== 'administrador' && this.usuarioActual.tipo !== 'creador') {
                    this.mostrarAlerta('Error', 'No tiene permisos para eliminar registros', 'error');
                    return;
                }
                
                const cantidad = tipo === 'aceptado' ? this.registrosAceptados.length : this.registrosObservados.length;
                
                if (cantidad === 0) {
                    this.mostrarAlerta('Información', `No hay registros ${tipo === 'aceptado' ? 'aceptados' : 'observados'} para eliminar`, 'info');
                    return;
                }
                
                if (confirm(`¿Está seguro de eliminar TODOS sus registros ${tipo === 'aceptado' ? 'aceptados' : 'observados'} (${cantidad} en total)?\n\n⚠️ ESTA ACCIÓN NO SE PUEDE DESHACER ⚠️`)) {
                    if (tipo === 'aceptado') {
                        this.registrosAceptados.forEach(registro => {
                            const indexGlobal = this.registrosAceptadosGlobales.findIndex(
                                item => item.nroPlaca === registro.nroPlaca &&
                                       item.usuarioRegistro === registro.usuarioRegistro
                            );
                            if (indexGlobal !== -1) {
                                this.registrosAceptadosGlobales.splice(indexGlobal, 1);
                            }
                        });
                        this.guardarAceptadosGlobales();
                        
                        this.registrosAceptados = [];
                    } else {
                        this.registrosObservados = [];
                    }
                    
                    this.guardarRegistrosEnLocalStorage();
                    this.actualizarContadores();
                    
                    if (tipo === 'aceptado') {
                        this.mostrarRegistrosAceptados();
                    } else {
                        this.mostrarRegistrosObservados();
                    }
                    
                    this.mostrarAlerta('Éxito', `Se eliminaron ${cantidad} registros ${tipo === 'aceptado' ? 'aceptados' : 'observados'}`, 'success');
                }
            }
            
            exportarAExcel(tipo) {
                let registros;
                let nombreTipo;
                
                if (tipo === 'aceptados') {
                    registros = this.registrosAceptados;
                    nombreTipo = 'aceptados';
                } else {
                    registros = this.registrosObservadosGlobales;
                    nombreTipo = 'observados';
                }
                
                if (registros.length === 0) {
                    this.mostrarAlerta('Advertencia', `No hay registros ${nombreTipo} para exportar`, 'warning');
                    return;
                }
                
                try {
                    const datos = registros.map(registro => [
                        registro.nroPlaca,
                        registro.numeroTramite || 'N/A',
                        registro.empresa || 'N/A',
                        registro.estadoTramite || 'N/A',
                        registro.tipoHR || 'N/A',
                        registro.observacion || '',
                        registro.fechaRegistro,
                        registro.usuarioRegistro || 'N/A'
                    ]);
                    
                    const headers = [
                        'PLACA',
                        'N° TRÁMITE',
                        'EMPRESA',
                        'ESTADO',
                        'TIPO HR',
                        'OBSERVACIÓN',
                        'FECHA REGISTRO',
                        'USUARIO'
                    ];
                    
                    datos.unshift(headers);
                    
                    const worksheet = XLSX.utils.aoa_to_sheet(datos);
                    const workbook = XLSX.utils.book_new();
                    XLSX.utils.book_append_sheet(workbook, worksheet, `Registros_${nombreTipo}`);
                    
                    const fecha = new Date().toISOString().slice(0, 10);
                    const nombreArchivo = `registros_${nombreTipo}_${this.usuarioActual.username}_${fecha}.xlsx`;
                    
                    XLSX.writeFile(workbook, nombreArchivo);
                    
                    this.mostrarAlerta('Éxito', `Se exportaron ${registros.length} registros ${nombreTipo} a Excel`, 'success');
                    
                } catch (error) {
                    console.error('Error exportando a Excel:', error);
                    this.mostrarAlerta('Error', 'No se pudo exportar a Excel: ' + error.message, 'error');
                }
            }
            
            mostrarAlerta(titulo, mensaje, tipo = 'info') {
                const alerta = document.createElement('div');
                
                let clase = 'alert-info';
                switch(tipo) {
                    case 'success': clase = 'alert-success'; break;
                    case 'error': clase = 'alert-error'; break;
                    case 'warning': clase = 'alert-warning'; break;
                }
                
                alerta.className = `alert ${clase}`;
                
                let icono = 'fas fa-info-circle';
                if (tipo === 'success') icono = 'fas fa-check-circle';
                if (tipo === 'error') icono = 'fas fa-times-circle';
                if (tipo === 'warning') icono = 'fas fa-exclamation-triangle';
                
                alerta.innerHTML = `
                    <i class="${icono}" style="font-size: 18px; margin-top: 2px;"></i>
                    <div>
                        <div style="font-size: 14px; margin-bottom: 4px; font-weight: 700;">${titulo}</div>
                        <div style="font-size: 13px; opacity: 0.9;">${mensaje}</div>
                    </div>
                `;
                
                document.body.appendChild(alerta);
                
                setTimeout(() => {
                    alerta.style.animation = 'slideOutAlert 0.3s ease-out';
                    setTimeout(() => {
                        if (alerta.parentNode) {
                            alerta.parentNode.removeChild(alerta);
                        }
                    }, 300);
                }, 4000);
            }
        }
        
        // Inicializar el sistema de autenticación
        let sistemaAuth;
        document.addEventListener('DOMContentLoaded', () => {
            sistemaAuth = new SistemaAutenticacion();
            console.log('✅ Sistema de Verificación de Placas Multi-Usuario inicializado');
            
            window.sistemaAuth = sistemaAuth;
        });
    </script>
</body>
</html>